
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>GCSE Maths (Foundation) — Number Topic Preview (N7–N9)</title>
<style>
  /* SECTION: Styles
     - Layout + typography
     - Question card UI
     - Input widgets (including drag-and-drop ordering and standard form EXP entry)
     NOTE: Keep classnames/IDs stable: the JS relies on many of them.
  */
  :root{
    --ink:#0f172a; --muted:#6b7280; --accent:#2563eb; --bg:#ffffff; --border:#e5e7eb;
    --green:#16a34a; --orange:#f59e0b; --red:#dc2626;
    --fbar:1px; /* ultra-thin fraction bar */
  }

  html,body{
    margin:0;padding:0;background:var(--bg);color:var(--ink);
    font:19px/1.65 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;
  }

  header{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--border)}
  main{max-width:1040px;margin:1.2rem auto 4rem;padding:0 1rem}

  /* top control bar (simple, no tabs) */
  .bar{
    display:flex;gap:.65rem;align-items:center;flex-wrap:wrap;
    padding:.75rem .9rem
  }
  .bar .group{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
  .bar label{font-weight:900;color:#111827;font-size:1rem}
  select, input[type="text"], input[type="number"]{
    padding:.55rem .65rem;border:1px solid var(--border);border-radius:.6rem;min-width:160px;
    background:#fff;color:var(--ink);font-size:1rem
  }
  input[type="text"], input[type="number"]{min-width:160px}
  .primary{
    background:var(--accent);color:#fff;border:1px solid var(--accent);
    border-radius:.65rem;padding:.6rem 1.05rem;cursor:pointer;font-weight:900;font-size:1rem
  }
  .ghost{
    background:#fff;color:var(--ink);border:1px solid var(--border);
    border-radius:.65rem;padding:.6rem 1.05rem;cursor:pointer;font-weight:900;font-size:1rem
  }
  .muted{color:var(--muted);font-size:1rem}
  .spacer{flex:1}
  .actions{display:flex;gap:.6rem;align-items:center;flex-wrap:wrap}

  /* question panel */
  .qpanel{border:1px solid var(--border);border-radius:1rem;overflow:hidden;margin-top:1rem;
    box-shadow:0 1px 0 rgba(0,0,0,.03)}
  .qhead{
    padding:1rem 1.05rem;border-bottom:1px solid var(--border);
    background:linear-gradient(180deg,#fbfdff,#f8fafc);
    display:flex;align-items:center;justify-content:space-between;gap:.7rem;flex-wrap:wrap
  }
  .qhead h3{margin:.1rem 0;font-size:1.2rem}
  .qbody{padding:1.1rem 1.05rem}
  .badge{display:inline-block;margin-left:.55rem;padding:.08rem .5rem;border:1px solid var(--border);
    border-radius:8px;background:#eef2ff;font-size:.95rem}
  .nc-tag{font-weight:900;text-transform:uppercase;letter-spacing:.02em;font-size:.95rem}
  .nc{color:#15803d}
  .calc{color:#1d4ed8}

  /* question lines */
  .item{padding:.6rem .1rem;border-bottom:1px dashed rgba(229,231,235,.9)}
  .item:last-child{border-bottom:none}
  .line{
    display:flex;align-items:flex-start;gap:.75rem;flex-wrap:wrap;
  }
  .qtext{flex:1;min-width:280px}
  .endmark{margin-left:.4rem;font-weight:900;color:#334155}

  .hlDigit{background:rgba(245,158,11,.25);border:1px solid rgba(245,158,11,.45);border-radius:.25rem;padding:0 .2rem;box-decoration-break:clone;-webkit-box-decoration-break:clone;}
  .sfhint{font-size:.85rem;color:#64748b;margin-top:.35rem;max-width:520px}

  /* inputs - feedback highlighting */
  .ok{outline:2px solid rgba(22,163,74,.35); border-color:rgba(22,163,74,.55)!important}
  .bad{outline:2px solid rgba(220,38,38,.28); border-color:rgba(220,38,38,.55)!important}

  /* fraction widget */
  .frac{display:inline-grid;grid-template-rows:auto 0 auto;row-gap:0;align-items:center;justify-items:center;line-height:0;vertical-align:middle}
  .frac input{
    width:92px;text-align:center;border:1px solid var(--border);border-radius:.45rem;padding:.45rem .5rem;margin:0;
    appearance:textfield;font-size:1rem;min-width:0
  }
  .frac input::-webkit-outer-spin-button,.frac input::-webkit-inner-spin-button{appearance:none;margin:0}
  .frac .bar{width:92px;height:0;border-top:var(--fbar) solid #111;margin:16px 0 0 0}
  .frac input:last-child{margin-top:-2px}

  /* pair/triple widgets */
  .twobox, .threebox, .sfbox{
    display:inline-flex;gap:.5rem;align-items:center;flex-wrap:wrap
  }
  .twobox input, .threebox input, .sfbox input{
    min-width:120px
  }
  .mini{min-width:110px!important}
  .tiny{min-width:90px!important}


  /* standard form input (no ^) */
  .sfTen{font-weight:900}
  .sfexp{
    vertical-align:super;
    font-size:.85rem;
    min-width:72px!important;
    width:72px;
    padding:.22rem .3rem;
  }

  /* prime factorisation input (EXP toggles superscripts) */
  .pfbox{
    min-height:44px;
    border:1px solid var(--border);
    border-radius:.55rem;
    padding:.45rem .55rem;
    background:#fff;
    font-weight:850;
    letter-spacing:.01em;
    line-height:1.2;
  }
  .pfbox sup{font-size:.75em;vertical-align:super}
  .pfbox .mul{opacity:.9;padding:0 .12rem}
  .kbtn.on{
    background:#2563eb;
    border-color:#2563eb;
    color:#fff;
  }

  /* prime factors keypad */
  .pfwrap{display:flex;flex-direction:column;gap:.5rem;min-width:320px}
  .keypad{display:flex;gap:.45rem;flex-wrap:wrap}
  .kbtn{
    border:1px solid var(--border);background:#fff;border-radius:.6rem;
    padding:.4rem .7rem;cursor:pointer;font-weight:900;font-size:1rem
  }
  .kbtn:active{transform:translateY(1px)}
  .kbtn.accent{border-color:rgba(37,99,235,.35);background:#eef2ff}

  /* feedback */
  .feedback{margin-top:1rem;border:1px solid var(--border);border-radius:.75rem;padding:.85rem 1rem;background:#f8fafc}
  .feedback.good{background:#ecfdf5;border-color:rgba(22,163,74,.22);color:#065f46}
  .feedback.bad{background:#fef2f2;border-color:rgba(220,38,38,.22);color:#7f1d1d}

  .mathwrap{display:inline-block;vertical-align:middle}

  /* -------------------- question tables (used in 4- and 5-mark questions) -------------------- */
  table.qtable{
    border-collapse:collapse;
    width:100%;
    max-width:540px;
    margin:.55rem 0 .25rem 0;
    font-size:1rem;
  }
  .qtable th, .qtable td{
    border:1px solid var(--border);
    padding:.38rem .6rem;
  }
  .qtable th{
    background:#f8fafc;
    font-weight:900;
  }
  .qtable .num{
    text-align:right;
    white-space:nowrap;
  }


  /* -------------------- drag ordering widget -------------------- */
  .drag-order{
    margin:.6rem 0 .1rem 0;
    padding:.6rem .65rem;
    border:1px solid var(--border);
    border-radius:1rem;
    background:linear-gradient(180deg,#ffffff,#f8fafc);
  }
  .drag-bank, .drag-targets{
    display:flex;
    gap:.5rem;
    flex-wrap:wrap;
    align-items:center;
  }
  .drag-bank{
    padding:.5rem;
    border:1px solid var(--border);
    border-radius:.85rem;
    background:#fff;
  }
  .drag-targets{
    margin-top:.55rem;
    padding:.5rem;
    border:1px dashed rgba(107,114,128,.35);
    border-radius:.85rem;
    background:#f8fafc;
    min-height:56px;
  }
  .dragbox{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding:.35rem .65rem;
    border:1px solid var(--border);
    border-radius:.7rem;
    background:#fff;
    cursor:grab;
    font-weight:900;
    user-select:none;
    -webkit-user-select:none;
    touch-action:manipulation;
  }
  .dragbox:active{ cursor:grabbing; }
  .dragbox.dragging{ opacity:.55; }
  .dragbox.selected{
    outline:2px solid rgba(37,99,235,.45);
    border-color:rgba(37,99,235,.55);
  }
  .dropbox{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    min-width:92px;
    min-height:46px;
    padding:.2rem .35rem;
    border:2px dashed rgba(229,231,235,.95);
    border-radius:.7rem;
    background:#fff;
  }
  .dropbox.over{
    border-color:rgba(37,99,235,.65);
    background:#eff6ff;
  }
  .dropbox .dragbox{ cursor:grab; }

  .drag-instr{
    margin-top:.45rem;
    color:var(--muted);
    font-size:1rem;
  }

  .dragbox math{ font-size:1.05em; }

  /* -------------------- standard form (single box + EXP keypad) -------------------- */
  .sfwrap{
    display:flex;
    flex-direction:column;
    gap:.55rem;
    min-width:320px;
  }
  .sfinput{
    padding:.55rem .65rem;
    border:1px solid var(--border);
    border-radius:.6rem;
    background:#fff;
    color:var(--ink);
    font-size:1rem;
    min-width:240px;
  }
  .sfhint{
    color:var(--muted);
    font-size:1rem;
  }

  @media (max-width:560px){
    .dropbox{ min-width:78px; }
    .sfwrap{ min-width:260px; }
  }

</style>
</head>
<body>

<header>
  <div class="bar">
    <div class="group">
      <label for="topicSel">Topic</label>
      <select id="topicSel"></select>
    </div>

    <div class="group">
      <label for="marksSel">Marks</label>
      <select id="marksSel">
        <option value="1">1 mark</option>
        <option value="2">2 marks</option>
        <option value="3">3 marks</option>
        <option value="4">4 marks</option>
        <option value="5">5 marks</option>
      </select>
    </div>

    <div class="group">
      <label for="calcSel">Paper</label>
      <select id="calcSel">
        <option value="noncalc">Non-calculator</option>
        <option value="calc">Calculator</option>
      </select>
    </div>

    <div class="spacer"></div>

    <div class="actions">
      <button class="primary" id="regenBtn" type="button">Regenerate numbers</button>
      <button class="ghost" id="checkBtn" type="button">Check</button>
      <button class="ghost" id="revealBtn" type="button">Reveal answers</button>
    </div>
  </div>
</header>

<main>
  <section id="preview"></section>
  <div class="feedback" id="fb" style="display:none"></div>
</main>

<script>
/* ============================================================
   GCSE (Foundation) Number Question Preview Tool (N1–N50)
   - NO ratio topics.
   - NO recurring decimals.
   - Finer-grained topics (each N code is a single narrow topic).
   - Marks selector gives a question that is worth those marks:
       higher marks => more steps / more answer boxes / more structure,
       not just “same question with bigger numbers”.
   - Calculator mode uses calculator-suitable numbers (messier decimals, awkward divisions),
     and where needed asks for answers to 2 decimal places.
   ============================================================ */

// SECTION: File map (searchable)
// - SECTION: Seeded RNG
// - SECTION: Formatting helpers (MathML, standard form parsing)
// - SECTION: Topic list / navigation (TOPICS)
// - SECTION: Scenario variants (contextVariants)
// - SECTION: Question parts (partInteger/partNumber/...)
// - SECTION: Build question card (buildQuestion switch by topic code)
// - SECTION: Rendering + interaction (tabs, check/reveal, drag ordering)
// EDIT HERE: Most question content is generated in buildQuestion(topicCode, marksTotal, rng).

// SECTION: Seeded RNG (deterministic per regeneration seed)
function hashToUint32(str){
  let h = 2166136261 >>> 0;
  for (let i=0;i<str.length;i++){
    h ^= str.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function cryptoSeed(){
  if (window.crypto && crypto.getRandomValues){
    const a = new Uint32Array(1);
    crypto.getRandomValues(a);
    return a[0] >>> 0;
  }
  return (Math.random()*2**32)>>>0;
}
function mulberry32(seed){
  let t = seed >>> 0;
  return function(){
    t += 0x6D2B79F5;
    let x = t;
    x = Math.imul(x ^ (x >>> 15), x | 1);
    x ^= x + Math.imul(x ^ (x >>> 7), x | 61);
    return ((x ^ (x >>> 14)) >>> 0) / 4294967296;
  };
}
function makeRng(seedLike){
  const seed = (seedLike===undefined || seedLike===null || seedLike==="")
    ? cryptoSeed()
    : (typeof seedLike==="number" ? (seedLike>>>0) : hashToUint32(String(seedLike)));
  const r = mulberry32(seed);
  return {
    seed,
    float: ()=>r(),
    int: (min,max)=>{
      min=Math.ceil(min); max=Math.floor(max);
      return Math.floor(r()*(max-min+1))+min;
    },
    choice: (arr)=>arr[Math.floor(r()*arr.length)],
    shuffle: (arr)=>{
      const a=arr.slice();
      for(let i=a.length-1;i>0;i--){
        const j=Math.floor(r()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      }
      return a;
    }
  };
}

/* -------------------- helpers -------------------- */
function gcd(a,b){a=Math.abs(a);b=Math.abs(b);while(b){[a,b]=[b,a%b]}return a||1}
function lcm(a,b){ return Math.abs(a*b)/gcd(a,b); }
function roundTo(x, dp){
  const f = 10**dp;
  return Math.round((+x + Number.EPSILON)*f)/f;
}
function fmt(x, maxDp=6){
  const n = Number(x);
  if(!Number.isFinite(n)) return String(x);
  const s = n.toFixed(maxDp);
  return s.replace(/\.?0+$/,"");
}

// Keep a fixed number of decimal places, but drop trailing ".00".
// Example: fmtNo00(100,2) -> "100"; fmtNo00(3.5,2) -> "3.50".
function fmtNo00(x, dp=2){
  const n = Number(x);
  if(!Number.isFinite(n)) return String(x);
  const s = n.toFixed(dp);
  return s.replace(/\.00$/,'');
}
function simpFrac(n,d){
  if(d===0) return {n:NaN,d:NaN};
  if(d<0){n=-n;d=-d}
  const g=gcd(n,d);
  return {n:n/g,d:d/g};
}
function fracEq(a,b){
  const x=simpFrac(a.n,a.d), y=simpFrac(b.n,b.d);
  return x.n===y.n && x.d===y.d;
}
function asNum(v){
  const s = String(v??"").trim().replace(/,/g,"");
  if(!s) return NaN;
  // allow fraction "a/b" in numeric fields
  if(s.includes("/")){
    const m = s.match(/^(-?\d+)\s*\/\s*(-?\d+)$/);
    if(!m) return NaN;
    const n=Number(m[1]), d=Number(m[2]);
    if(!Number.isFinite(n)||!Number.isFinite(d)||d===0) return NaN;
    return n/d;
  }
  // allow leading +, decimals
  const x = Number(s);
  return Number.isFinite(x) ? x : NaN;
}
function close(a,b,tol=1e-8){ return Math.abs(a-b) <= tol; }

function parseStandardFormInput(raw){
  // Accept forms like:
  // 3.2×10⁵   3.2x10^5   3.2E5   3.2×10-5  (Unicode superscripts supported)
  const s0 = String(raw ?? "").trim();
  if(!s0) return null;

  // Normalise
  let s = s0.replace(/\s+/g,"");
  s = s.replace(/×/g,"x").replace(/⋅/g,"x").replace(/·/g,"x");
  s = s.replace(/EXP/ig,"E");
  s = s.replace(/[−–—]/g,"-"); // unicode minus/dashes

  // Convert Unicode superscripts to normal digits/sign
  const supMap = {"⁰":"0","¹":"1","²":"2","³":"3","⁴":"4","⁵":"5","⁶":"6","⁷":"7","⁸":"8","⁹":"9","⁻":"-","⁺":"+"};
  s = s.replace(/[⁰¹²³⁴⁵⁶⁷⁸⁹⁻⁺]/g, ch => supMap[ch] ?? ch);

  // Standardise multiply symbol
  s = s.replace(/X/g,"x");

  // Pattern A: mantissa E exponent
  let m = s.match(/^([+-]?\d*\.?\d+)E([+-]?\d+)$/i);
  if(m){
    const mantissa = Number(m[1]);
    const exp = parseInt(m[2],10);
    if(!Number.isFinite(mantissa) || !Number.isFinite(exp)) return null;
    return {mantissa, exp, value: mantissa * Math.pow(10, exp)};
  }

  // Pattern B: mantissa × 10 ^ exponent  (caret optional, exponent may follow immediately after 10)
  m = s.match(/^([+-]?\d*\.?\d+)(?:x|\*)10\^?([+-]?\d+)$/i);
  if(m){
    const mantissa = Number(m[1]);
    const exp = parseInt(m[2],10);
    if(!Number.isFinite(mantissa) || !Number.isFinite(exp)) return null;
    return {mantissa, exp, value: mantissa * Math.pow(10, exp)};
  }

  return null;
}


/* -------------------- MathML helpers -------------------- */
const MNS = `http://www.w3.org/1998/Math/MathML`;
function mfrac(n,d){
  return `<span class="mathwrap"><math xmlns="${MNS}" display="inline"><mfrac><mn>${n}</mn><mn>${d}</mn></mfrac></math></span>`;
}
function msup(base, exp){
  const baseNode = Number.isFinite(+base) ? `<mn>${base}</mn>` : `<mi>${String(base)}</mi>`;
  return `<span class="mathwrap"><math xmlns="${MNS}" display="inline"><msup>${baseNode}<mn>${exp}</mn></msup></math></span>`;
}

// SECTION: Topic list / tab navigation
// EDIT HERE: To add/remove topics or change the tab label, edit the TOPICS array below.
// NOTE: Each `code` must have a corresponding `case "CODE"` in the buildQuestion() switch.
/* SPLITMERGE:TOPICS-START */
const TOPICS = [
  {code:"N7",  name:"Multiplication (integers & decimals)"},
  {code:"N8",  name:"Division (integers & decimals)"},
  {code:"N9",  name:"Negative numbers (mixed operations)"}
];
/* SPLITMERGE:TOPICS-END */

/* -------------------- number pickers -------------------- */
function pickDec(rng, dp){
  // dp digits after decimal, always non-trailing safe
  const m = 10**dp;
  return rng.int(1*m, 999*m)/m;
}
function pickMoney(rng, isCalc){
  // money prices: noncalc => 2 dp but friendly; calc => awkward 2 dp
  const pennies = isCalc ? rng.int(105, 2999) : rng.choice([125,150,175,200,225,250,275,300,350,400,450,500,550,600,650,700,750,800,900,1000,1200,1500]);
  return pennies/100;
}
function pickNiceInt(rng, min=2, max=40){ return rng.int(min, max); }
function pickBigInt(rng){ return rng.int(1200, 98000); }

function pickPercent(rng, allowOneDp=false){
  // GCSE-friendly percentages (no recurring). If allowOneDp, may return values like 12.5 or 7.5.
  const ints = [1,2,3,4,5,6,8,10,12,15,18,20,25,30,35,40,45,50,60,75,80,90];
  const oneDp = [2.5,7.5,12.5,17.5,22.5,37.5,62.5];
  return allowOneDp ? rng.choice(ints.concat(oneDp)) : rng.choice(ints);
}

/* -------------------- part constructors -------------------- */
function partNumber(id, textHtml, marks, value){
  return {marks, textHtml, input:{kind:"number", id}, answer:{type:"number", value}};
}
function partInteger(id, textHtml, marks, value){
  return {marks, textHtml, input:{kind:"integer", id}, answer:{type:"number", value}};
}
function partFraction(id, textHtml, marks, frac){
  return {marks, textHtml, input:{kind:"fraction", id}, answer:{type:"fraction", value: frac}};
}
function partPair(id, textHtml, marks, pair, opts={}){
  return {marks, textHtml, input:{kind:(opts.kind||"pair"), id, placeholders:opts.placeholders, labels:opts.labels}, answer:{type:"pair", value: pair}};
}
function partStdForm(id, textHtml, marks, val, nMaybe){
  // val can be:
  //  - the actual numeric value to be written in standard form, OR
  //  - (A, n) where val is A and nMaybe is the power of 10.
  const num = (typeof nMaybe !== "undefined")
    ? (Number(val) * (10**Number(nMaybe)))
    : Number(val);
  return {marks, textHtml, input:{kind:"standardForm", id}, answer:{type:"standardForm", value: num}};
}
function partOrder(id, textHtml, marks, correctTokens){
  return {marks, textHtml, input:{kind:"order", id}, answer:{type:"order", value: correctTokens}};
}
function partPrimeFactors(id, textHtml, marks, primeMap){
  // primeMap: {2:3, 3:1, ...}
  return {marks, textHtml, input:{kind:"primeFactors", id}, answer:{type:"primeFactors", value: primeMap}};
}
function partMoney(id, textHtml, marks, value){
  return {marks, textHtml, input:{kind:"money", id}, answer:{type:"number", value}};
}

// Display-only block (no input / no marks). Useful for putting tables above part (a)/(b)
// so that answer boxes align horizontally with the question line.
function partDisplay(textHtml){
  return {marks:0, textHtml, input:null, answer:null};
}

// Rounded-number marking:
// - Full marks if the calculation is correct and the student has rounded to <= dpReq.
// - If the calculation is correct but rounding is not done (too many decimal places), deduct 1 mark.
// - If the rounding is incorrect but within ±1 of the last required decimal place, deduct 1 mark.
function partRounded(id, textHtml, marks, rawValue, dpReq, kind="number"){
  const raw = Number(rawValue);
  const dp = Number(dpReq);
  return {
    marks,
    textHtml,
    input:{kind, id},
    answer:{type:"rounded", value: roundTo(raw, dp), raw, dp}
  };
}

function partSymbol(id, textHtml, marks, value){
  return {marks, textHtml, input:{kind:"symbol", id}, answer:{type:"symbol", value}};
}

/* -------------------- prime factor helpers -------------------- */
function factorise(n){
  // returns map {p:exp}, n is integer >=2
  let x = Math.abs(Math.trunc(n));
  const map = {};
  let p = 2;
  while(p*p <= x){
    while(x % p === 0){
      map[p] = (map[p]||0) + 1;
      x = Math.trunc(x/p);
    }
    p = (p===2) ? 3 : p+2;
  }
  if(x>1) map[x] = (map[x]||0)+1;
  return map;
}
function mapsEqual(a,b){
  const ka = Object.keys(a).sort();
  const kb = Object.keys(b).sort();
  if(ka.length!==kb.length) return false;
  for(let i=0;i<ka.length;i++){
    if(ka[i]!==kb[i]) return false;
    if(a[ka[i]]!==b[kb[i]]) return false;
  }
  return true;
}

// SECTION: Build one question card (topic + mark band)
// EDIT HERE: Each topic's question generator lives inside the switch(topicCode) below.
// - Adjust wording/values/answer keys within a topic `case`.
// - Keep IDs/classnames stable (the UI + checking logic rely on them).
// - To add a new topic, add it to TOPICS and add a matching case in this switch.
function buildQuestion(topicCode, marksTotal, paperMode, rng){
  const isCalc = paperMode === "calc";

  // SECTION: Scenario/context variants (3+ marks only)
  // These are injected directly into the student-facing prompt text (no separate context label above the question).
  // CHANGE REQUESTS #5/#6: N5 and N11 contexts are now specific and randomly selected.
  const contextVariants = (code)=>{
    switch(code){
      case "N7":
      case "N47":
        return [
        "A customer is buying items in a local shop.",
        "A group is buying tickets and snacks at a cinema.",
        "A charity stall is selling items to raise money."
        ];
      case "N46":
        return [
        "A cyclist records a distance and the time taken for a journey.",
        "A driver records a distance and the time taken for a trip.",
        "A runner records a distance and the time taken for training."
        ];
      case "N48":
        return [
        "A student uses a timetable to work out times during the day.",
        "A traveller plans a journey using start times and durations.",
        "An athlete uses race times and durations to plan a schedule."
        ];
      case "N37":
      case "N38":
      case "N39":
      case "N49":
      case "N50":
        return [
        "A scientist writes very large numbers using standard form.",
        "A lab report uses standard form for very small measurements.",
        "A computer stores very large and very small values in standard form."
        ];
      case "N43":
      case "N44":
      case "N45":
        return [
        "A technician records a measurement rounded to a stated accuracy.",
        "A coach records a distance or time rounded to a stated accuracy.",
        "A science experiment records readings rounded to a stated accuracy."
        ];
      // CHANGE REQUEST #6 (N11): Replace vague scenario prompts with specific, realistic contexts.
      case "N11":
        return [
        "A café uses a till that does two steps to work out a bill total.",
        "A delivery company uses a two-step rule to work out charges for parcels.",
        "A school club uses a two-step rule to work out how many packs are needed."
        ];
      case "N12":
      case "N13":
      case "N14":
      case "N15":
      case "N16":
      case "N32":
        return [
        "Items are being packed into equal groups.",
        "A team is arranging equipment evenly.",
        "A factory is making products in equal batches."
        ];
      case "N17":
      case "N18":
      case "N19":
      case "N20":
      case "N21":
      case "N22":
      case "N23":
      case "N24":
      case "N25":
      case "N26":
      case "N31":
        return [
        "A recipe uses fractional amounts of ingredients and portions.",
        "A DIY job uses fractions to measure, cut and share materials.",
        "A sports setting uses fractions of a lap or a match."
        ];
      // CHANGE REQUEST #5 (N5): Provide specific contexts for addition/subtraction (including negatives).
      case "N5":
        return [
        "A bank account changes with deposits and withdrawals.",
        "A temperature changes overnight, then changes again during the day.",
        "A football team tracks points gained and points lost across two matches."
        ];
      case "N27":
      case "N28":
      case "N29":
      case "N30":
      case "N33":
      case "N34":
      case "N35":
      case "N36":
        return [
        "A shop is using prices, discounts and offers.",
        "A charity is tracking amounts towards a target.",
        "A school is comparing scores and attendance figures."
        ];
      default:
        return [
        "A student is using numbers from an everyday situation.",
        "Someone is using numbers to complete a practical task.",
        "A real-life problem requires interpreting numbers accurately."
        ];
    }
  };

  // helper: create object
  const Q = (parts)=>{
    // For 3–5 mark questions, randomly select ONE of three context variants
    // and prepend it to the prompt. (Maths stays identical; only the setting changes.)
    if(marksTotal>=3 && !["N7","N8"].includes(topicCode)){
      const leads = contextVariants(topicCode) || [];
      if(leads.length>=3){
        const lead = rng.choice(leads);
        for(const p of parts){
          if(p && typeof p.textHtml==="string" && p.textHtml.trim()!==""){
            // Insert the chosen scenario into the question text itself (no separate context line).
            const original = p.textHtml;
            const trimmed = original.trimStart();
            if(trimmed.toLowerCase().startsWith('<p')){
              const idx = original.toLowerCase().indexOf('<p');
              const end = original.indexOf('>', idx);
              if(end !== -1){
                p.textHtml = original.slice(0, end+1) + lead + ' ' + original.slice(end+1);
              } else {
                p.textHtml = lead + ' ' + original;
              }
            } else {
              p.textHtml = lead + ' ' + original;
            }
            break;
          }
        }
      }
    }
    return {topicCode, marksTotal, paperMode, parts};
  };

  // helper: "calc style" rounding to 2 dp for awkward results
  const need2dp = isCalc; // calculator questions will often say 2 d.p.

  switch(topicCode){
    /* SPLITMERGE:BUILDQUESTION-CASES-START */    case "N7": {
      // N7 — Multiplication (scenario-based)
      // - Scenario 1 is money; scenarios 2 & 3 are non-money
      // - Tables used only for 4- and 5-mark questions
      // - Non-calculator: whole numbers (except simple decimal × 10/100/1000 style)
      // - Calculator: decimals used in the question
      // - (a) / (b) labels are bold

      const sc = rng.int(1,3);

      const fmtMoney = (x)=>{
        const s = Number(x).toFixed(2);
        return s.replace(/\.00$/,'');
      };

      // Money with 2 d.p. (avoids whole pounds like 12.00)
      const money2dp = (minP, maxP)=>{
        let p;
        do{ p = rng.int(minP, maxP); }while(p % 100 === 0);
        return p/100;
      };

      // Decimal with a chosen dp, avoiding integers
      const decDp = (min, max, dp)=>{
        const scale = 10**dp;
        let v;
        for(let i=0;i<500;i++){
          v = rng.int(Math.ceil(min*scale), Math.floor(max*scale)) / scale;
          if(!Number.isInteger(v)) return v;
        }
        return (Math.ceil(min*scale)+1)/scale;
      };

      const dpWord = (dp)=> dp===1 ? "decimal place" : "decimal places";

      // ---------- NON-CALCULATOR ----------
      if(!isCalc){
        if(marksTotal===1){
          if(sc===1){
            // 2-digit × 1-digit
            const price = rng.int(10, 30);
            const qty = rng.int(3, 9);
            return Q([
              partMoney("n7_1_nc_s1", `A bus ticket costs <b>£${price}</b>. Work out the cost of <b>${qty}</b> tickets. <span class="endmark">[1]</span>`, 1, price*qty),
            ]);
          }
          if(sc===2){
            // 2-digit × 1-digit
            const rate = rng.int(10, 99);
            const mins = rng.int(3, 9);
            return Q([
              partInteger("n7_1_nc_s2", `A machine packs <b>${rate}</b> boxes per minute. How many boxes in <b>${mins}</b> minutes? <span class="endmark">[1]</span>`, 1, rate*mins),
            ]);
          }

          // simple decimal × 10/100 (non-calculator friendly)
          const laps = rng.choice([10, 100]);
          const lapKm = roundTo(decDp(0.11, 0.99, 2), 2); // km
          const dist = roundTo(lapKm * laps, 2);
          return Q([
            partNumber("n7_1_nc_s3", `One lap is <b>${fmt(lapKm,2)} km</b>. A runner does <b>${laps}</b> laps. Work out the distance. <span class="endmark">[1]</span>`, 1, dist),
          ]);
        }

        if(marksTotal===2){
          // Single 2-digit × 2-digit multiplication
          if(sc===1){
            const sandwich = rng.int(10, 25);
            const qSand = rng.int(10, 29);
            const total = sandwich*qSand;
            return Q([
              partMoney("n7_2_nc_s1", `A sandwich costs <b>£${sandwich}</b>. A customer buys <b>${qSand}</b> sandwiches. Work out the total cost. <span class="endmark">[2]</span>`, 2, total),
            ]);
          }
          if(sc===2){
            const perBook = rng.int(20, 48);
            const nBook = rng.int(10, 25);
            const total = perBook*nBook;
            return Q([
              partInteger("n7_2_nc_s2", `A printer makes <b>${perBook}</b> pages per booklet. It prints <b>${nBook}</b> booklets. Work out the total pages. <span class="endmark">[2]</span>`, 2, total),
            ]);
          }

          const gym = rng.int(30, 75);
          const nGym = rng.int(10, 25);
          const total = gym*nGym;
          return Q([
            partInteger("n7_2_nc_s3", `A gym session lasts <b>${gym}</b> minutes. A person does <b>${nGym}</b> gym sessions. Work out the total time. <span class="endmark">[2]</span>`, 2, total),
          ]);
        }

        if(marksTotal===3){
          if(sc===1){
            // DEAL (set numbers so the key multiplication is 2-digit × 2-digit)
            const price = rng.int(10, 25);
            const bought = rng.choice([30,33,36,39,42,45]); // multiple of 3
            const payFor = Math.floor(bought/3)*2;
            const total = price*payFor;
            return Q([
              partMoney("n7_3_nc_s1", `A café sells muffins for <b>£${price}</b> each.<br>Offer: “Buy <b>3</b> muffins for the price of <b>2</b>.”<br>A customer buys <b>${bought}</b> muffins.<br>Work out the total cost using the offer. <span class="endmark">[3]</span>`, 3, total),
            ]);
          }
          if(sc===2){
            const rate = rng.int(10, 25);
            const sat = rng.int(6, 9);
            const sun = rng.int(6, 9);
            const hours = sat + sun; // 12–18
            const pay = rate * hours;
            return Q([
              partMoney("n7_3_nc_s2", `A worker earns <b>£${rate}</b> per hour.<br>They work <b>${sat}</b> hours on Saturday and <b>${sun}</b> hours on Sunday.<br>Work out their total pay. <span class="endmark">[3]</span>`, 3, pay),
            ]);
          }

          const perTrip = rng.int(10, 30);
          const mon = rng.int(6, 9);
          const tue = rng.int(6, 9);
          const trips = mon + tue;
          const totalDist = perTrip * trips;
          return Q([
            partInteger("n7_3_nc_s3", `A delivery driver travels <b>${perTrip}</b> km per trip.<br>On Monday they do <b>${mon}</b> trips. On Tuesday they do <b>${tue}</b> trips.<br>Work out the total distance travelled. <span class="endmark">[3]</span>`, 3, totalDist),
          ]);
        }

        if(marksTotal===4){
          // Tables; marking structure:
          // (a) [1] one item type only
          // (b) [3] two item types + TOTAL for ALL items (includes part a)
          if(sc===1){
            // Money table
            const tshirt = rng.int(6, 15);
            const cap = rng.int(10, 20); // 2-digit for 1-mark component
            const hoodie = rng.int(15, 35);
            const socks = rng.int(2, 8);

            const table = `
              <table class="qtable">
                <tr><th>Item</th><th class="num">Cost</th></tr>
                <tr><td>T-shirt</td><td class="num">£${tshirt}</td></tr>
                <tr><td>Cap</td><td class="num">£${cap}</td></tr>
                <tr><td>Hoodie</td><td class="num">£${hoodie}</td></tr>
                <tr><td>Socks</td><td class="num">£${socks}</td></tr>
              </table>`;

            const qCap = rng.int(2,5);

            const opts = [
              {name:"T-shirt", plural:"T-shirts", cost:tshirt},
              {name:"Hoodie", plural:"hoodies", cost:hoodie},
              {name:"Socks", plural:"pairs of socks", cost:socks},
            ];
            const chosen = rng.shuffle(opts).slice(0,2);
            const q1 = rng.int(2,5);
            const q2 = rng.int(2,5);

            const aAns = qCap*cap;
            const bAns = aAns + q1*chosen[0].cost + q2*chosen[1].cost;

            return Q([
              partMoney("n7_4_nc_s1a", `A shop sells items at the prices shown.${table}<br><b>(a)</b> Work out the cost of <b>${qCap}</b> caps. <span class="endmark">[1]</span>`, 1, aAns),
              partMoney("n7_4_nc_s1b", `<b>(b)</b> A customer also buys <b>${q1}</b> ${chosen[0].plural} and <b>${q2}</b> ${chosen[1].plural}.<br>Work out the <b>TOTAL</b> cost for <b>ALL</b> the items bought. <span class="endmark">[3]</span>`, 3, bAns),
            ]);
          }
          if(sc===2){
            // Journey time table
            const s2c = rng.int(12, 25);
            const c2s = rng.int(10, 20);
            const s2sh = rng.int(12, 22);
            const sh2s = rng.int(15, 28);

            const table = `
              <table class="qtable">
                <tr><th>Journey</th><th class="num">Time (minutes)</th></tr>
                <tr><td>Station to College</td><td class="num">${s2c}</td></tr>
                <tr><td>College to Sports Hall</td><td class="num">${c2s}</td></tr>
                <tr><td>Sports Hall to Shops</td><td class="num">${s2sh}</td></tr>
                <tr><td>Shops to Station</td><td class="num">${sh2s}</td></tr>
              </table>`;

            const qA = rng.int(2,5);
            const opts = [
              {phrase:"journeys from Station to College", time:s2c},
              {phrase:"journeys from Sports Hall to Shops", time:s2sh},
              {phrase:"journeys from Shops to Station", time:sh2s},
            ];
            const chosen = rng.shuffle(opts).slice(0,2);
            const q1 = rng.int(2,5);
            const q2 = rng.int(2,5);

            const aAns = qA*c2s;
            const bAns = aAns + q1*chosen[0].time + q2*chosen[1].time;

            return Q([
              partInteger("n7_4_nc_s2a", `A taxi firm records journey times.${table}<br><b>(a)</b> Work out the time for <b>${qA}</b> journeys from College to Sports Hall. <span class="endmark">[1]</span>`, 1, aAns),
              partInteger("n7_4_nc_s2b", `<b>(b)</b> A driver also makes <b>${q1}</b> ${chosen[0].phrase} and <b>${q2}</b> ${chosen[1].phrase}.<br>Work out the <b>TOTAL</b> time for <b>ALL</b> the journeys. <span class="endmark">[3]</span>`, 3, bAns),
            ]);
          }

          // Electricity table
          const kettle = rng.choice([1200,1500,1800,2000,2200]);
          const micro = rng.choice([700,800,900]);
          const tv = rng.choice([90,120,150,180]);
          const lamp = rng.choice([40,60,75,100]);

          const table = `
            <table class="qtable">
              <tr><th>Appliance</th><th class="num">Power (W)</th></tr>
              <tr><td>Kettle</td><td class="num">${kettle}</td></tr>
              <tr><td>Microwave</td><td class="num">${micro}</td></tr>
              <tr><td>TV</td><td class="num">${tv}</td></tr>
              <tr><td>Lamp</td><td class="num">${lamp}</td></tr>
            </table>`;

          const qA = rng.int(2,5);
          const opts = [
            {plural:"kettles", val:kettle},
            {plural:"TVs", val:tv},
            {plural:"lamps", val:lamp},
          ];
          const chosen = rng.shuffle(opts).slice(0,2);
          const q1 = rng.int(2,5);
          const q2 = rng.int(2,5);

          const aAns = qA*micro;
          const bAns = aAns + q1*chosen[0].val + q2*chosen[1].val;

          return Q([
            partInteger("n7_4_nc_s3a", `The power of appliances is shown.${table}<br><b>(a)</b> Work out the power for <b>${qA}</b> microwaves running at the same time. <span class="endmark">[1]</span>`, 1, aAns),
            partInteger("n7_4_nc_s3b", `<b>(b)</b> A household also uses <b>${q1}</b> ${chosen[0].plural} and <b>${q2}</b> ${chosen[1].plural} (at the same time).<br>Work out the <b>TOTAL</b> power for <b>ALL</b> of these appliances. <span class="endmark">[3]</span>`, 3, bAns),
          ]);
        }

        if(marksTotal===5){
          // Tables; mixed styles
          if(sc===1){
            // Keep totals below £100 so the change is always positive.
            const planner = rng.int(2, 5);
            const pen = rng.int(2, 4);
            const calc = rng.int(6, 10);
            const ruler = rng.int(1, 2);

            const table = `
              <table class="qtable">
                <tr><th>Item</th><th class="num">Cost</th></tr>
                <tr><td>Planner</td><td class="num">£${planner}</td></tr>
                <tr><td>Pen pack</td><td class="num">£${pen}</td></tr>
                <tr><td>Calculator</td><td class="num">£${calc}</td></tr>
                <tr><td>Ruler</td><td class="num">£${ruler}</td></tr>
              </table>`;

            let qPlanner, qPen, qCalc, qRuler;
            let aTotal, allTotal, change;

            for(let tries=0; tries<200; tries++){
              qPlanner = rng.int(2,5);
              qPen = rng.int(2,5);
              qCalc = rng.int(2,5);
              qRuler = rng.int(2,5);

              aTotal = qPlanner*planner + qPen*pen;
              allTotal = aTotal + qCalc*calc + qRuler*ruler;
              change = 100 - allTotal;

              if(change >= 0) break;
            }

            return Q([
              partMoney("n7_5_nc_s1a", `A school shop sells items.${table}<br><b>(a)</b> A student buys <b>${qPlanner}</b> planners and <b>${qPen}</b> pen packs.<br>Work out the total cost. <span class="endmark">[2]</span>`, 2, aTotal),
              partMoney("n7_5_nc_s1b", `<b>(b)</b> The student also buys <b>${qCalc}</b> calculators and <b>${qRuler}</b> rulers.<br>They pay with <b>£100</b>.<br>Work out the change they get. <span class="endmark">[3]</span>`, 3, change),
            ]);
          }

          if(sc===2){
            const gloves = rng.int(12, 30);
            const bottles = rng.int(10, 24);
            const tins = rng.int(8, 20);
            const sponges = rng.int(12, 35);

            const table = `
              <table class="qtable">
                <tr><th>Item type</th><th class="num">Items per box</th></tr>
                <tr><td>Gloves</td><td class="num">${gloves}</td></tr>
                <tr><td>Bottles</td><td class="num">${bottles}</td></tr>
                <tr><td>Tins</td><td class="num">${tins}</td></tr>
                <tr><td>Sponges</td><td class="num">${sponges}</td></tr>
              </table>`;

            const bGloves = rng.int(2,5);
            const bBottles = rng.int(2,5);
            const bTins = rng.int(2,5);
            const bSponges = rng.int(2,5);

            const aTotal = bGloves*gloves + bBottles*bottles;
            const allTotal = aTotal + bTins*tins + bSponges*sponges;

            return Q([
              partInteger("n7_5_nc_s2a", `A warehouse packs items into boxes.${table}<br><b>(a)</b> The warehouse packs <b>${bGloves}</b> boxes of gloves and <b>${bBottles}</b> boxes of bottles.<br>Work out the number of items packed. <span class="endmark">[2]</span>`, 2, aTotal),
              partInteger("n7_5_nc_s2b", `<b>(b)</b> It also packs <b>${bTins}</b> boxes of tins and <b>${bSponges}</b> boxes of sponges.<br>Work out the <b>TOTAL</b> number of items packed altogether for <b>ALL</b> boxes. <span class="endmark">[3]</span>`, 3, allTotal),
            ]);
          }

          // sessions
          const swim = rng.int(30, 60);
          const fit = rng.int(45, 75);
          const yoga = rng.int(30, 60);
          const bad = rng.int(35, 70);

          const table = `
            <table class="qtable">
              <tr><th>Session type</th><th class="num">Minutes per session</th></tr>
              <tr><td>Swimming</td><td class="num">${swim}</td></tr>
              <tr><td>Fitness class</td><td class="num">${fit}</td></tr>
              <tr><td>Yoga</td><td class="num">${yoga}</td></tr>
              <tr><td>Badminton</td><td class="num">${bad}</td></tr>
            </table>`;

          const nSwim = rng.int(2,5);
          const nYoga = rng.int(2,5);
          const nFit = rng.int(2,5);
          const nBad = rng.int(2,5);

          const week1 = nSwim*swim + nYoga*yoga;
          const week2 = nFit*fit + nBad*bad;
          const left = 2000 - (week1 + week2);

          return Q([
            partInteger("n7_5_nc_s3a", `A leisure centre runs sessions.${table}<br><b>(a)</b> In one week, the centre runs <b>${nSwim}</b> swimming sessions and <b>${nYoga}</b> yoga sessions.<br>Work out the total minutes. <span class="endmark">[2]</span>`, 2, week1),
            partInteger("n7_5_nc_s3b", `<b>(b)</b> In the next week, it runs <b>${nFit}</b> fitness classes and <b>${nBad}</b> badminton sessions.<br>A member has <b>2000</b> minutes available across both weeks.<br>Work out how many minutes are left. <span class="endmark">[3]</span>`, 3, left),
          ]);
        }
      }

      // ---------- CALCULATOR ----------
      if(marksTotal===1){
        if(sc===1){
          // ticket cost (3-digit × 2-digit, decimals included)
          const price = money2dp(1200, 9999); // £12.00–£99.99
          const qty = (rng.float() < 0.7) ? rng.int(120, 360) : rng.int(12, 96);
          const total = roundTo(price * qty, 2);
          return Q([
            partMoney("n7_1_c_s1", `A bus ticket costs <b>£${price.toFixed(2)}</b>. Work out the cost of <b>${qty}</b> tickets. Give your answer to <b>2</b> decimal places. <span class="endmark">[1]</span>`, 1, total),
          ]);
        }
        if(sc===2){
          // boxes per minute (2-digit × 2-digit, decimals included)
          const rate = decDp(10.1, 99.9, 1);
          const mins = rng.int(12, 30);
          const total = roundTo(rate * mins, 1);
          return Q([
            partNumber("n7_1_c_s2", `A machine packs <b>${fmt(rate,1)}</b> boxes per minute. How many boxes in <b>${mins}</b> minutes? Give your answer to <b>1</b> decimal place. <span class="endmark">[1]</span>`, 1, total),
          ]);
        }

        const lap = decDp(120.1, 899.9, 1);
        const laps = rng.int(12, 30);
        const total = roundTo(lap * laps, 1);
        return Q([
          partNumber("n7_1_c_s3", `One lap is <b>${fmt(lap,1)} m</b>. A runner does <b>${laps}</b> laps. Work out the distance. Give your answer to <b>1</b> decimal place. <span class="endmark">[1]</span>`, 1, total),
        ]);
      }

      if(marksTotal===2){
        if(sc===1){
          const sandwich = money2dp(1000, 2599);
          const qSand = rng.int(10, 29);
          const total = roundTo(sandwich*qSand, 2);
          return Q([
            partMoney("n7_2_c_s1", `A sandwich costs <b>£${sandwich.toFixed(2)}</b>. A customer buys <b>${qSand}</b> sandwiches. Work out the total cost. Give your answer to <b>2</b> decimal places. <span class="endmark">[2]</span>`, 2, total),
          ]);
        }
        if(sc===2){
          const perBook = decDp(20.1, 48.9, 1);
          const nBook = rng.int(10, 25);
          const total = roundTo(perBook*nBook, 2);
          return Q([
            partNumber("n7_2_c_s2", `A printer makes <b>${fmt(perBook,1)}</b> pages per booklet. It prints <b>${nBook}</b> booklets. Work out the total pages. Give your answer to <b>2</b> decimal places. <span class="endmark">[2]</span>`, 2, total),
          ]);
        }

        const gym = decDp(30.1, 75.9, 1);
        const nGym = rng.int(10, 25);
        const total = roundTo(gym*nGym, 2);
        return Q([
          partNumber("n7_2_c_s3", `A gym session lasts <b>${fmt(gym,1)}</b> minutes. A person does <b>${nGym}</b> gym sessions. Work out the total time. Give your answer to <b>2</b> decimal places. <span class="endmark">[2]</span>`, 2, total),
        ]);
      }

      if(marksTotal===3){
        if(sc===1){
          const price = money2dp(1000, 2599);
          const bought = rng.choice([30,33,36,39,42,45]);
          const payFor = Math.floor(bought/3)*2;
          const total = roundTo(price*payFor, 2);
          return Q([
            partMoney("n7_3_c_s1", `A café sells muffins for <b>£${price.toFixed(2)}</b> each.<br>Offer: “Buy <b>3</b> muffins for the price of <b>2</b>.”<br>A customer buys <b>${bought}</b> muffins.<br>Work out the total cost using the offer. Give your answer to <b>2</b> decimal places. <span class="endmark">[3]</span>`, 3, total),
          ]);
        }
        if(sc===2){
          // produce ≥4 d.p. before rounding by using 2 d.p. × 2 d.p.
          const rate = money2dp(1000, 2599);
          const sat = roundTo(decDp(4.25, 8.75, 2), 2);
          const sun = roundTo(decDp(4.25, 8.75, 2), 2);
          const raw = rate * (sat + sun);
          return Q([
            partRounded("n7_3_c_s2", `A worker earns <b>£${rate.toFixed(2)}</b> per hour.<br>They work <b>${fmt(sat,2)}</b> hours on Saturday and <b>${fmt(sun,2)}</b> hours on Sunday.<br>Work out their total pay to <b>2</b> decimal places. <span class="endmark">[3]</span>`, 3, raw, 2, "money"),
          ]);
        }

        const perTrip = decDp(10.0001, 30.9999, 4); // 4 d.p.
        const mon = rng.int(6, 9);
        const tue = rng.int(6, 9);
        const trips = mon + tue;
        const raw = perTrip * trips;
        const dpReq = rng.choice([1,2,3]);
        return Q([
          partRounded("n7_3_c_s3", `A delivery driver travels <b>${perTrip.toFixed(4)}</b> km per trip.<br>On Monday they do <b>${mon}</b> trips. On Tuesday they do <b>${tue}</b> trips.<br>Work out the total distance travelled, rounded to <b>${dpReq}</b> ${dpWord(dpReq)}. <span class="endmark">[3]</span>`, 3, raw, dpReq),
        ]);
      }

      if(marksTotal===4){
        if(sc===1){
          const tshirt = money2dp(600, 1500);
          const cap = money2dp(800, 2000);
          const hoodie = money2dp(1500, 3500);
          const socks = money2dp(100, 800);

          const table = `
            <table class="qtable">
              <tr><th>Item</th><th class="num">Cost</th></tr>
              <tr><td>T-shirt</td><td class="num">£${tshirt.toFixed(2)}</td></tr>
              <tr><td>Cap</td><td class="num">£${cap.toFixed(2)}</td></tr>
              <tr><td>Hoodie</td><td class="num">£${hoodie.toFixed(2)}</td></tr>
              <tr><td>Socks</td><td class="num">£${socks.toFixed(2)}</td></tr>
            </table>`;

          const qCap = rng.int(2,5);

          const opts = [
            {plural:"T-shirts", cost:tshirt},
            {plural:"hoodies", cost:hoodie},
            {plural:"pairs of socks", cost:socks},
          ];
          const chosen = rng.shuffle(opts).slice(0,2);
          const q1 = rng.int(2,5);
          const q2 = rng.int(2,5);

          const aAns = roundTo(qCap*cap, 2);
          const bAns = roundTo(aAns + q1*chosen[0].cost + q2*chosen[1].cost, 2);

          return Q([
            partMoney("n7_4_c_s1a", `A shop sells items at the prices shown.${table}<br><b>(a)</b> Work out the cost of <b>${qCap}</b> caps. Give your answer to <b>2</b> decimal places. <span class="endmark">[1]</span>`, 1, aAns),
            partMoney("n7_4_c_s1b", `<b>(b)</b> A customer also buys <b>${q1}</b> ${chosen[0].plural} and <b>${q2}</b> ${chosen[1].plural}.<br>Work out the <b>TOTAL</b> cost for <b>ALL</b> the items bought. Give your answer to <b>2</b> decimal places. <span class="endmark">[3]</span>`, 3, bAns),
          ]);
        }
        if(sc===2){
          const s2c = decDp(12.0001, 25.9999, 2);
          const c2s = decDp(10.0001, 20.9999, 2);
          const s2sh = decDp(12.0001, 22.9999, 2);
          const sh2s = decDp(15.0001, 28.9999, 2);

          const table = `
            <table class="qtable">
              <tr><th>Journey</th><th class="num">Time (minutes)</th></tr>
              <tr><td>Station to College</td><td class="num">${s2c.toFixed(2)}</td></tr>
              <tr><td>College to Sports Hall</td><td class="num">${c2s.toFixed(2)}</td></tr>
              <tr><td>Sports Hall to Shops</td><td class="num">${s2sh.toFixed(2)}</td></tr>
              <tr><td>Shops to Station</td><td class="num">${sh2s.toFixed(2)}</td></tr>
            </table>`;

          const qA = rng.int(2,5);
          const opts = [
            {phrase:"journeys from Station to College", time:s2c},
            {phrase:"journeys from Sports Hall to Shops", time:s2sh},
            {phrase:"journeys from Shops to Station", time:sh2s},
          ];
          const chosen = rng.shuffle(opts).slice(0,2);
          const q1 = rng.int(2,5);
          const q2 = rng.int(2,5);

          const aAns = roundTo(qA*c2s, 2);
          const bAns = roundTo(aAns + q1*chosen[0].time + q2*chosen[1].time, 2);

          return Q([
            partNumber("n7_4_c_s2a", `A taxi firm records journey times.${table}<br><b>(a)</b> Work out the time for <b>${qA}</b> journeys from College to Sports Hall. Give your answer to <b>2</b> decimal places. <span class="endmark">[1]</span>`, 1, aAns),
            partNumber("n7_4_c_s2b", `<b>(b)</b> A driver also makes <b>${q1}</b> ${chosen[0].phrase} and <b>${q2}</b> ${chosen[1].phrase}.<br>Work out the <b>TOTAL</b> time for <b>ALL</b> the journeys. Give your answer to <b>2</b> decimal places. <span class="endmark">[3]</span>`, 3, bAns),
          ]);
        }

        // Power ratings in kW (decimals are realistic in this context)
        const kettle = decDp(1.20, 2.40, 2);
        const micro = decDp(0.70, 1.20, 2);
        const tv = decDp(0.09, 0.25, 2);
        const lamp = decDp(0.04, 0.15, 2);

        const table = `
          <table class="qtable">
            <tr><th>Appliance</th><th class="num">Power (kW)</th></tr>
            <tr><td>Kettle</td><td class="num">${kettle.toFixed(2)}</td></tr>
            <tr><td>Microwave</td><td class="num">${micro.toFixed(2)}</td></tr>
            <tr><td>TV</td><td class="num">${tv.toFixed(2)}</td></tr>
            <tr><td>Lamp</td><td class="num">${lamp.toFixed(2)}</td></tr>
          </table>`;

        const qA = rng.int(2,5);
        const opts = [
          {plural:"kettles", val:kettle},
          {plural:"TVs", val:tv},
          {plural:"lamps", val:lamp},
        ];
        const chosen = rng.shuffle(opts).slice(0,2);
        const q1 = rng.int(2,5);
        const q2 = rng.int(2,5);

        const aAns = roundTo(qA*micro, 2);
        const bAns = roundTo(aAns + q1*chosen[0].val + q2*chosen[1].val, 2);

        return Q([
          partNumber("n7_4_c_s3a", `The power of appliances is shown.${table}<br><b>(a)</b> Work out the power for <b>${qA}</b> microwaves running at the same time. Give your answer to <b>2</b> decimal places. <span class="endmark">[1]</span>`, 1, aAns),
          partNumber("n7_4_c_s3b", `<b>(b)</b> A household also uses <b>${q1}</b> ${chosen[0].plural} and <b>${q2}</b> ${chosen[1].plural} (at the same time).<br>Work out the <b>TOTAL</b> power for <b>ALL</b> of these appliances. Give your answer to <b>2</b> decimal places. <span class="endmark">[3]</span>`, 3, bAns),
        ]);
      }

      if(marksTotal===5){
        if(sc===1){
          // Keep totals below £100 so the change is always positive.
          const planner = money2dp(200, 549);
          const pen = money2dp(200, 449);
          const calc = money2dp(600, 949);
          const ruler = money2dp(100, 199);

          const table = `
            <table class="qtable">
              <tr><th>Item</th><th class="num">Cost</th></tr>
              <tr><td>Planner</td><td class="num">£${planner.toFixed(2)}</td></tr>
              <tr><td>Pen pack</td><td class="num">£${pen.toFixed(2)}</td></tr>
              <tr><td>Calculator</td><td class="num">£${calc.toFixed(2)}</td></tr>
              <tr><td>Ruler</td><td class="num">£${ruler.toFixed(2)}</td></tr>
            </table>`;

          let qPlanner, qPen, qCalc, qRuler;
          let aTotal, allTotal, change;

          for(let tries=0; tries<300; tries++){
            qPlanner = rng.int(2,5);
            qPen = rng.int(2,5);
            qCalc = rng.int(2,5);
            qRuler = rng.int(2,5);

            aTotal = roundTo(qPlanner*planner + qPen*pen, 2);
            allTotal = roundTo(aTotal + qCalc*calc + qRuler*ruler, 2);
            change = roundTo(100 - allTotal, 2);

            if(change >= 0) break;
          }

          return Q([
            partMoney("n7_5_c_s1a", `A school shop sells items.${table}<br><b>(a)</b> A student buys <b>${qPlanner}</b> planners and <b>${qPen}</b> pen packs.<br>Work out the total cost. Give your answer to <b>2</b> decimal places. <span class="endmark">[2]</span>`, 2, aTotal),
            partMoney("n7_5_c_s1b", `<b>(b)</b> The student also buys <b>${qCalc}</b> calculators and <b>${qRuler}</b> rulers.<br>They pay with <b>£100</b>.<br>Work out the change they get. Give your answer to <b>2</b> decimal places. <span class="endmark">[3]</span>`, 3, change),
          ]);
        }

        if(sc===2){
          // Realistic calculator context (decimals make sense): paint tins.
          // Using (2 d.p.) × (2 d.p.) ensures answers have ≥4 d.p. before rounding.
          const dpReq = rng.choice([1,2,3]);

          const paintNames = rng.shuffle(["Standard paint","Outdoor paint","Primer","Gloss"]);
          const rows = paintNames.map(name=>({
            name,
            vol: decDp(1.25, 6.25, 2),        // litres per tin
            cov: decDp(6.50, 15.50, 2)        // m² per litre
          }));

          const table = `
            <table class="qtable">
              <tr><th>Paint type</th><th class="num">Volume per tin (L)</th><th class="num">Coverage (m² per L)</th></tr>
              ${rows.map(r=>`<tr><td>${r.name}</td><td class="num">${r.vol.toFixed(2)}</td><td class="num">${r.cov.toFixed(2)}</td></tr>`).join("")}
            </table>`;

          const t1 = rng.int(2,5);
          const t2 = rng.int(2,5);
          const t3 = rng.int(2,5);
          const t4 = rng.int(2,5);

          const rawA = t1*(rows[0].vol*rows[0].cov) + t2*(rows[1].vol*rows[1].cov);
          const rawAll = rawA + t3*(rows[2].vol*rows[2].cov) + t4*(rows[3].vol*rows[3].cov);

          return Q([
            partRounded("n7_5_c_s2a", `A decorator uses paint. The table shows the volume of paint in each tin and the coverage rate.${table}<br><b>(a)</b> The decorator buys <b>${t1}</b> tins of <b>${rows[0].name}</b> and <b>${t2}</b> tins of <b>${rows[1].name}</b>.<br>Work out the total area that can be painted (in m²), rounded to <b>${dpReq}</b> ${dpWord(dpReq)}. <span class="endmark">[2]</span>`, 2, rawA, dpReq),
            partRounded("n7_5_c_s2b", `<b>(b)</b> The decorator also buys <b>${t3}</b> tins of <b>${rows[2].name}</b> and <b>${t4}</b> tins of <b>${rows[3].name}</b>.<br>Work out the <b>TOTAL</b> area that can be painted with all the tins (in m²), rounded to <b>${dpReq}</b> ${dpWord(dpReq)}. <span class="endmark">[3]</span>`, 3, rawAll, dpReq),
          ]);
        }

        // Realistic calculator context (decimals make sense): energy use.
        // Using (2 d.p.) × (2 d.p.) gives ≥4 d.p. in the unrounded totals.
        const dpReq = rng.choice([1,2,3]);

        const deviceNames = rng.shuffle(["Treadmill","Rowing machine","Exercise bike","Cross trainer"]);
        const rows = deviceNames.map(name=>({
          name,
          power: decDp(0.30, 2.50, 2),   // kW
          time: decDp(0.25, 1.75, 2)     // hours per session
        }));

        const table = `
          <table class="qtable">
            <tr><th>Equipment</th><th class="num">Power (kW)</th><th class="num">Time per session (hours)</th></tr>
            ${rows.map(r=>`<tr><td>${r.name}</td><td class="num">${r.power.toFixed(2)}</td><td class="num">${r.time.toFixed(2)}</td></tr>`).join("")}
          </table>`;

        const n1 = rng.int(2,5);
        const n2 = rng.int(2,5);
        const n3 = rng.int(2,5);
        const n4 = rng.int(2,5);

        const rawWeek1 = n1*(rows[0].power*rows[0].time) + n2*(rows[1].power*rows[1].time);
        const rawWeek2 = n3*(rows[2].power*rows[2].time) + n4*(rows[3].power*rows[3].time);
        const rawTotal = rawWeek1 + rawWeek2;

        // Budget shown to 2 d.p.; leftover keeps ≥4 d.p. because rawTotal has ≥4 d.p.
        let extra = decDp(5.25, 30.75, 2);
        let budget = roundTo(rawTotal, 2) + extra;
        budget = roundTo(budget, 2);
        // Avoid showing a whole number like 20.00
        if((Math.round(budget*100) % 100) === 0) budget = roundTo(budget + 0.01, 2);

        const rawLeft = budget - rawTotal;

        return Q([
          partRounded("n7_5_c_s3a", `A gym tracks energy use. The table shows the power of equipment and the time used per session.${table}<br><b>(a)</b> In one week, the gym runs <b>${n1}</b> sessions on <b>${rows[0].name}</b> and <b>${n2}</b> sessions on <b>${rows[1].name}</b>.<br>Work out the total energy used (in kWh), rounded to <b>${dpReq}</b> ${dpWord(dpReq)}. <span class="endmark">[2]</span>`, 2, rawWeek1, dpReq),
          partRounded("n7_5_c_s3b", `<b>(b)</b> In the next week, the gym runs <b>${n3}</b> sessions on <b>${rows[2].name}</b> and <b>${n4}</b> sessions on <b>${rows[3].name}</b>.<br>The gym has an energy budget of <b>${budget.toFixed(2)}</b> kWh for both weeks.<br>Work out how many kWh are left, rounded to <b>${dpReq}</b> ${dpWord(dpReq)}. <span class="endmark">[3]</span>`, 3, rawLeft, dpReq),
        ]);
      }

      // Fallback
      return Q([partInteger("n7_f", `Work out: <b>24 × 3</b>. <span class="endmark">[1]</span>`, 1, 72)]);
    }    case "N8": {
      // N8 — Division (with multiplication/addition/subtraction where needed) — GCSE style
      // Rules followed:
      // - Questions grouped by mark value (1–5), each with 3 scenario variants
      // - Scenario 1 is money; scenarios 2 & 3 are non-money
      // - Division is required in EVERY question
      // - If there are parts (a) and (b), BOTH parts contain division
      // - Tables used only for 4- and 5-mark questions
      // - Non-calculator: whole numbers in the question
      // - Calculator: decimals used in the question

      const sc = rng.int(1,3);

      // helpers
      const pickPence = (minP,maxP)=>{
        let p;
        do{ p = rng.int(minP,maxP); }while(p%100===0);
        return p;
      };
      const ceilDiv = (a,b)=> Math.floor((a + b - 1)/b);
      const gcd = (a,b)=>{ a=Math.abs(a); b=Math.abs(b); while(b){ const t=a%b; a=b; b=t; } return a; };

      // -------------------- 1 MARK --------------------
      if(marksTotal===1){
        if(sc===1){
          // Scenario 1 (Money): share equally
          if(!isCalc){
            const people = rng.choice([3,4,5,6,7,8,9,10,12]);
            const each = rng.int(8,30);
            const total = people*each;
            return Q([partMoney("n8_1", `£${total} is shared equally between <b>${people}</b> people. How much does each person get? <span class="endmark">[1]</span>`, 1, each)]);
          }else{
            const people = rng.choice([3,4,5,6,7,8,9,10,12]);
            const eachP = pickPence(600, 3500);
            const totalP = eachP*people;
            return Q([partMoney("n8_1c", `£${fmtNo00(totalP/100,2)} is shared equally between <b>${people}</b> people. How much does each person get? Give your answer to <b>2</b> decimal places. <span class="endmark">[1]</span>`, 1, roundTo(eachP/100,2))]);
          }
        }

        if(sc===2){
          // Scenario 2 (Non-money: length): cut into equal pieces
          if(!isCalc){
            const pieces = rng.choice([4,5,6,8,9,10,12]);
            const each = rng.int(6,30);
            const total = pieces*each;
            return Q([partInteger("n8_1l", `A rope is <b>${total} cm</b> long. It is cut into <b>${pieces}</b> equal pieces. How long is each piece? <span class="endmark">[1]</span>`, 1, each)]);
          }else{
            const pieces = rng.choice([4,5,6,8,9,10,12]);
            let eachC = rng.int(50, 350); // 0.50–3.50 m (in hundredths)
            if(eachC%100===0) eachC+=15;
            const totalC = eachC*pieces;
            return Q([partNumber("n8_1lc", `A rope is <b>${fmtNo00(totalC/100,2)} m</b> long. It is cut into <b>${pieces}</b> equal pieces. How long is each piece? Give your answer to <b>2</b> decimal places. <span class="endmark">[1]</span>`, 1, roundTo(eachC/100,2))]);
          }
        }

        // Scenario 3 (Non-money: mass): share equally
        if(!isCalc){
          const bowls = rng.choice([3,4,5,6,8,9,10,12]);
          const each = rng.int(40,200);
          const total = bowls*each;
          return Q([partInteger("n8_1m", `<b>${total} g</b> of pasta is shared equally into <b>${bowls}</b> bowls. How many grams are in each bowl? <span class="endmark">[1]</span>`, 1, each)]);
        }else{
          const containers = rng.choice([4,5,6,8,9,10,12]);
          let eachC = rng.int(20, 250); // 0.20–2.50 kg (hundredths)
          if(eachC%100===0) eachC+=7;
          const totalC = eachC*containers;
          return Q([partNumber("n8_1mc", `<b>${fmtNo00(totalC/100,2)} kg</b> of rice is shared equally into <b>${containers}</b> containers. How many kilograms are in each container? Give your answer to <b>2</b> decimal places. <span class="endmark">[1]</span>`, 1, roundTo(eachC/100,2))]);
        }
      }

      // -------------------- 2 MARK --------------------
      if(marksTotal===2){
        if(sc===1){
          // Scenario 1 (Money): share then subtract spending
          if(!isCalc){
            const people = rng.choice([6,8,10,12,15]);
            const share = rng.int(10,40);
            const spend = rng.int(1, Math.max(1,share-1));
            const total = share*people;
            const left = share - spend;
            return Q([partMoney("n8_2", `£${total} is shared equally between <b>${people}</b> people.<br>Each person then spends <b>£${spend}</b>.<br>How much money does each person have left? <span class="endmark">[2]</span>`, 2, left)]);
          }else{
            const people = rng.choice([6,7,8,9,10,12]);
            let shareP = pickPence(900, 5000);
            let spendP = pickPence(100, Math.min(2500, shareP-1));
            while(spendP>=shareP) spendP = pickPence(100, Math.min(2500, shareP-1));
            const totalP = shareP*people;
            const leftP = shareP - spendP;
            return Q([partMoney("n8_2c", `£${fmtNo00(totalP/100,2)} is shared equally between <b>${people}</b> people.<br>Each person then spends <b>£${fmtNo00(spendP/100,2)}</b>.<br>How much money does each person have left? Give your answer to <b>2</b> decimal places. <span class="endmark">[2]</span>`, 2, roundTo(leftP/100,2))]);
          }
        }

        if(sc===2){
          // Scenario 2 (Non-money: time): split then add a break to EACH section
          if(!isCalc){
            const sections = rng.choice([4,5,6,8,9,10,12]);
            const base = rng.int(15,50);
            const total = base*sections;
            const brk = rng.int(3,10);
            const ans = base + brk;
            return Q([partInteger("n8_2t", `A coach trip takes <b>${total}</b> minutes.<br>It is split into <b>${sections}</b> equal sections.<br>Then <b>${brk}</b> minutes is added to <b>EACH</b> section for a break.<br>How long is <b>EACH</b> section now? <span class="endmark">[2]</span>`, 2, ans)]);
          }else{
            const sections = rng.choice([4,5,6,8,9,10,12]);
            let baseT = rng.int(150, 600); // tenths
            if(baseT%10===0) baseT+=3; // force decimal
            const base = baseT/10;
            const total = base*sections; // exact to 1 dp
            let brkC = rng.int(25, 525); // hundredths
            if(brkC%100===0) brkC+=11;
            const brk = brkC/100;
            const ans = roundTo(base + brk,2);
            return Q([partNumber("n8_2tc", `A coach trip takes <b>${fmt(total,2)}</b> minutes.<br>It is split into <b>${sections}</b> equal sections.<br>Then <b>${fmt(brk,2)}</b> minutes is added to <b>EACH</b> section for a break.<br>How long is <b>EACH</b> section now? Give your answer to <b>2</b> decimal places. <span class="endmark">[2]</span>`, 2, ans)]);
          }
        }

        // Scenario 3 (Non-money: packing): divide then divide again
        if(!isCalc){
          const bags = rng.choice([4,5,6,7,8,9,10,12]);
          const friends = rng.choice([2,3,4,5]);
          const each = rng.int(6,40);
          const total = each*bags*friends;
          return Q([partInteger("n8_2p", `<b>${total}</b> stickers are packed equally into <b>${bags}</b> bags.<br>Then each bag is shared equally between <b>${friends}</b> friends.<br>How many stickers does each friend get? <span class="endmark">[2]</span>`, 2, each)]);
        }else{
          const bags = rng.choice([4,5,6,7,8,9,10,12]);
          const people = rng.choice([2,3,4,5]);
          let eachC = rng.int(250, 2500); // hundredths of a gram: 2.50–25.00 g
          if(eachC%100===0) eachC+=17;
          const totalC = eachC*bags*people;
          return Q([partNumber("n8_2pc", `<b>${fmt(totalC/100,2)} g</b> of sweets are packed equally into <b>${bags}</b> bags.<br>Then each bag is shared equally between <b>${people}</b> people.<br>How many grams does each person get? Give your answer to <b>2</b> decimal places. <span class="endmark">[2]</span>`, 2, roundTo(eachC/100,2))]);
        }
      }

      // -------------------- 3 MARK --------------------
      if(marksTotal===3){
        if(sc===1){
          // Scenario 1 (Money): share, then fraction to charity
          if(!isCalc){
            const people = rng.choice([6,7,8,9,10,12]);
            const share = rng.int(4,12)*3; // divisible by 3
            const total = share*people;
            const charity = share/3;

            return Q([
              partMoney("n8_3a", `<b>(a)</b> <b>£${total}</b> is shared equally between <b>${people}</b> people. Work out how much each person gets. <span class="endmark">[1]</span>`, 1, share),
              partMoney("n8_3b", `<b>(b)</b> Each person gives <b>one-third</b> of their share to charity.<br>Work out how much money each person gives. <span class="endmark">[2]</span>`, 2, charity),
            ]);
          }else{
            const people = rng.choice([6,7,8,9,10,12]);
            let shareP;
            do{ shareP = pickPence(800, 5000); }while(shareP%4!==0);
            const totalP = shareP*people;
            const charityP = shareP/4;

            return Q([
              partMoney("n8_3ac", `<b>(a)</b> <b>£${fmtNo00(totalP/100,2)}</b> is shared equally between <b>${people}</b> people. Work out how much each person gets. Give your answer to <b>2</b> decimal places. <span class="endmark">[1]</span>`, 1, roundTo(shareP/100,2)),
              partMoney("n8_3bc", `<b>(b)</b> Each person gives <b>one-quarter</b> of their share to charity.<br>Work out how much money each person gives. Give your answer to <b>2</b> decimal places. <span class="endmark">[2]</span>`, 2, roundTo(charityP/100,2)),
            ]);
          }
        }

        if(sc===2){
          // Scenario 2 (Non-money: distance): speed, then laps
          if(!isCalc){
            const speed = rng.int(12,30);
            const hoursA = rng.choice([4,5,6,7,8]);
            const distA = speed*hoursA;

            let hoursB = rng.choice([3,4,5,6]);
            let distB = speed*hoursB;

            const lapsOptions = [6,8,9,10,12];
            let laps = rng.choice(lapsOptions);
            let guard=0;
            while(distB%laps!==0 && guard<50){
              laps = rng.choice(lapsOptions);
              guard++;
            }
            if(distB%laps!==0){
              // adjust hoursB if needed
              hoursB = 4;
              distB = speed*hoursB;
              laps = 8;
            }
            const lapLen = distB/laps;

            return Q([
              partInteger("n8_3d_a", `<b>(a)</b> A cyclist travels <b>${distA} km</b> in <b>${hoursA}</b> hours. Work out the average speed in km per hour. <span class="endmark">[1]</span>`, 1, speed),
              partInteger("n8_3d_b", `<b>(b)</b> The cyclist cycles for <b>${hoursB}</b> hours at the same speed.<br>The distance is shared equally over <b>${laps}</b> identical laps.<br>Work out the length of <b>EACH</b> lap. <span class="endmark">[2]</span>`, 2, lapLen),
            ]);
          }else{
            // calculator version (decimals)
            let speedT = rng.int(120, 320); // tenths
            if(speedT%10===0) speedT+=3;
            const speed = speedT/10;

            const hoursA = rng.choice([5.5,6.5,7.5,8.5]);
            const distA = roundTo(speed*hoursA,2);

            const lapsOptions = [7,8,9,10,12];
            let hoursB, distBInt, laps, lapLen;
            let guard=0;
            while(guard<200){
              hoursB = rng.choice([2.4,2.8,3.2,3.6,4.0,4.5]);
              const distB = speed*hoursB;              // exact to 2 dp (0.1×0.1)
              distBInt = Math.round(distB*100);
              laps = rng.choice(lapsOptions);
              if(distBInt%laps===0){
                lapLen = (distBInt/laps)/100;
                break;
              }
              guard++;
            }
            if(guard>=200){
              hoursB = 3.6;
              const distB = speed*hoursB;
              distBInt = Math.round(distB*100);
              laps = 9;
              lapLen = (distBInt/laps)/100;
            }

            return Q([
              partNumber("n8_3dc_a", `<b>(a)</b> A cyclist travels <b>${fmt(distA,2)} km</b> in <b>${fmt(hoursA,2)}</b> hours. Work out the average speed in km per hour. Give your answer to <b>2</b> decimal places. <span class="endmark">[1]</span>`, 1, roundTo(speed,2)),
              partNumber("n8_3dc_b", `<b>(b)</b> The cyclist cycles for <b>${fmt(hoursB,2)}</b> hours at the same speed.<br>The distance is shared equally over <b>${laps}</b> identical laps.<br>Work out the length of <b>EACH</b> lap. Give your answer to <b>2</b> decimal places. <span class="endmark">[2]</span>`, 2, roundTo(lapLen,2)),
            ]);
          }
        }

        // Scenario 3 (Non-money: food portions): divide then divide again
        if(!isCalc){
          const bowls = rng.choice([4,5,6,8,9,10,12]);
          const children = rng.choice([2,3,4,5,6]);
          const eachChild = rng.int(3,12);
          const eachBowl = eachChild*children;
          const total = eachBowl*bowls;

          return Q([
            partInteger("n8_3f_a", `<b>(a)</b> <b>${total}</b> strawberries are shared equally into <b>${bowls}</b> bowls. How many strawberries are in each bowl? <span class="endmark">[1]</span>`, 1, eachBowl),
            partInteger("n8_3f_b", `<b>(b)</b> Each bowl is then shared equally between <b>${children}</b> children.<br>How many strawberries does <b>EACH</b> child get? <span class="endmark">[2]</span>`, 2, eachChild),
          ]);
        }else{
          const jugs = rng.choice([6,7,8,9,10]);
          const cups = rng.choice([5,6,7,8,9]);
          const eachCupC = rng.int(5, 50); // 0.05–0.50 L in hundredths
          const eachJugC = eachCupC*cups;  // hundredths
          const totalC = eachJugC*jugs;    // hundredths
          return Q([
            partNumber("n8_3fc_a", `<b>(a)</b> <b>${fmtNo00(totalC/100,2)} litres</b> of juice are shared equally into <b>${jugs}</b> jugs. How many litres are in each jug? Give your answer to <b>2</b> decimal places. <span class="endmark">[1]</span>`, 1, roundTo(eachJugC/100,2)),
            partNumber("n8_3fc_b", `<b>(b)</b> Each jug is then poured equally into <b>${cups}</b> cups.<br>How many litres are in <b>EACH</b> cup? Give your answer to <b>2</b> decimal places. <span class="endmark">[2]</span>`, 2, roundTo(eachCupC/100,2)),
          ]);
        }
      }

      // -------------------- 4 MARK (TABLE) --------------------
      if(marksTotal===4){
        if(sc===1){
          // Scenario 1 (Money) — table
          if(!isCalc){
            const ticket = rng.int(7,15);
            const drink = rng.int(2,6);
            const popcorn = rng.int(3,7);
            const sweets = rng.int(2,6);

            const peopleShareA = 3; // share popcorn cost
            const peopleShareB = 6; // share leftover
            const popcornCost = 6*popcorn;          // total popcorn spend
            const eachA = popcornCost/peopleShareA; // exact integer

            // Construct budget so "as much as possible" on tickets leaves a remainder divisible by 6
            const k = rng.int(8,16); // number of tickets bought
            const remainderOptions = [];
            for(let r=0; r<ticket; r++){
              if(r%peopleShareB===0) remainderOptions.push(r);
            }
            const rem = rng.choice(remainderOptions.length?remainderOptions:[0]);
            const budget = popcornCost + ticket*k + rem;
            const eachB = rem/peopleShareB;

            const table = `
              <table class="qtable">
                <tr><th>Item</th><th class="num">Cost</th></tr>
                <tr><td>Ticket</td><td class="num">£${ticket}</td></tr>
                <tr><td>Drink</td><td class="num">£${drink}</td></tr>
                <tr><td>Popcorn</td><td class="num">£${popcorn}</td></tr>
                <tr><td>Sweets</td><td class="num">£${sweets}</td></tr>
              </table>`;

            return Q([
              partMoney("n8_4a", `A group has <b>£${budget}</b> to spend. Prices are shown below.${table}<br><b>(a)</b> The group buys <b>6</b> popcorns and shares the cost equally between <b>3</b> people.<br>Work out how much <b>EACH</b> person pays. <span class="endmark">[1]</span>`, 1, eachA),
              partMoney("n8_4b", `<b>(b)</b> The group then spends as much of the remaining money as possible on tickets.<br>The money left after buying the tickets is shared equally between <b>6</b> people.<br>Work out how much <b>EACH</b> person gets. <span class="endmark">[3]</span>`, 3, eachB),
            ]);
          }else{
            const ticketP = pickPence(750, 1500);
            const drinkP = pickPence(250, 700);
            const popcornP = pickPence(300, 800);
            const sweetsP = pickPence(200, 650);

            const peopleShareA = 3;
            const peopleShareB = 6;

            const popcornCostP = 6*popcornP;
            const eachA = roundTo((popcornCostP/peopleShareA)/100,2);

            const k = rng.int(8,16);
            const remOptions=[];
            for(let r=0; r<ticketP; r++){
              if(r%peopleShareB===0) remOptions.push(r);
            }
            const remP = rng.choice(remOptions.length?remOptions:[0]);
            const budgetP = popcornCostP + ticketP*k + remP;
            const eachB = roundTo((remP/peopleShareB)/100,2);

            const table = `
              <table class="qtable">
                <tr><th>Item</th><th class="num">Cost</th></tr>
                <tr><td>Ticket</td><td class="num">£${(ticketP/100).toFixed(2)}</td></tr>
                <tr><td>Drink</td><td class="num">£${(drinkP/100).toFixed(2)}</td></tr>
                <tr><td>Popcorn</td><td class="num">£${(popcornP/100).toFixed(2)}</td></tr>
                <tr><td>Sweets</td><td class="num">£${(sweetsP/100).toFixed(2)}</td></tr>
              </table>`;

            return Q([
              partMoney("n8_4ac", `A group has <b>£${fmtNo00(budgetP/100,2)}</b> to spend. Prices are shown below.${table}<br><b>(a)</b> The group buys <b>6</b> popcorns and shares the cost equally between <b>3</b> people.<br>Work out how much <b>EACH</b> person pays. Give your answer to <b>2</b> decimal places. <span class="endmark">[1]</span>`, 1, eachA),
              partMoney("n8_4bc", `<b>(b)</b> The group then spends as much of the remaining money as possible on tickets.<br>The money left after buying the tickets is shared equally between <b>6</b> people.<br>Work out how much <b>EACH</b> person gets. Give your answer to <b>2</b> decimal places. <span class="endmark">[3]</span>`, 3, eachB),
            ]);
          }
        }

        if(sc===2){
          // Scenario 2 (Non-money: compost bags) — table
          if(!isCalc){
            // build a simple increasing mass table (whole numbers)
            const small = rng.choice([1,2,3]);
            const medium = small + rng.choice([1,1,2]);
            const large = medium + rng.choice([1,1,2]);
            const xlarge = large + rng.choice([1,1,2]);

            // (a) total mass shared equally
            const groups = rng.choice([4,5,6,7,8]);
            const eachKg = rng.int(2,8);
            const totalKg = eachKg*groups;

            // (b) bags needed + share bags equally
            let bLarge = rng.int(3,10);
            let bSmall = rng.int(2,10);
            while((bLarge+bSmall)%4!==0){
              bLarge = rng.int(3,10);
              bSmall = rng.int(2,10);
            }
            const reqLarge = (bLarge-1)*large + rng.int(1,large);
            const reqSmall = (bSmall-1)*small + rng.int(1,small);
            const ansBags = (bLarge+bSmall)/4;

            const table = `
              <table class="qtable">
                <tr><th>Bag size</th><th class="num">Mass per bag (kg)</th></tr>
                <tr><td>Extra large</td><td class="num">${xlarge}</td></tr>
                <tr><td>Large</td><td class="num">${large}</td></tr>
                <tr><td>Medium</td><td class="num">${medium}</td></tr>
                <tr><td>Small</td><td class="num">${small}</td></tr>
              </table>`;

            return Q([
              partInteger("n8_4p_a", `Compost is sold in bags. The mass of each bag is shown.${table}<br><b>(a)</b> <b>${totalKg} kg</b> of compost is shared equally between <b>${groups}</b> groups.<br>Work out the mass <b>EACH</b> group gets. <span class="endmark">[1]</span>`, 1, eachKg),
              partInteger("n8_4p_b", `<b>(b)</b> A garden needs <b>${reqLarge} kg</b> of compost in large bags and <b>${reqSmall} kg</b> in small bags.<br>Bags must be bought as whole bags.<br>The <b>TOTAL</b> number of bags bought is shared equally between <b>4</b> gardeners.<br>Work out how many bags <b>EACH</b> gardener receives. <span class="endmark">[3]</span>`, 3, ansBags),
            ]);
          }else{
            // masses with decimals (hundredths kg)
            let masses = [];
            while(masses.length<4){
              const v = pickPence(80, 450); // 0.80–4.50 kg
              if(!masses.includes(v)) masses.push(v);
            }
            masses.sort((a,b)=>a-b);
            const [smallC, mediumC, largeC, xlargeC] = masses;

            const groups = rng.choice([4,5,6,7,8]);
            let eachC = rng.int(150, 650);
            if(eachC%100===0) eachC+=13;
            const totalC = eachC*groups;

            let bLarge = rng.int(3,10);
            let bSmall = rng.int(2,10);
            while((bLarge+bSmall)%4!==0){
              bLarge = rng.int(3,10);
              bSmall = rng.int(2,10);
            }
            const reqLargeC = (bLarge-1)*largeC + rng.int(1,largeC);
            const reqSmallC = (bSmall-1)*smallC + rng.int(1,smallC);
            const ansBags = (bLarge+bSmall)/4;

            const table = `
              <table class="qtable">
                <tr><th>Bag size</th><th class="num">Mass per bag (kg)</th></tr>
                <tr><td>Extra large</td><td class="num">${(xlargeC/100).toFixed(2)}</td></tr>
                <tr><td>Large</td><td class="num">${(largeC/100).toFixed(2)}</td></tr>
                <tr><td>Medium</td><td class="num">${(mediumC/100).toFixed(2)}</td></tr>
                <tr><td>Small</td><td class="num">${(smallC/100).toFixed(2)}</td></tr>
              </table>`;

            return Q([
              partNumber("n8_4pc_a", `Compost is sold in bags. The mass of each bag is shown.${table}<br><b>(a)</b> <b>${fmtNo00(totalC/100,2)} kg</b> of compost is shared equally between <b>${groups}</b> groups.<br>Work out the mass <b>EACH</b> group gets. Give your answer to <b>2</b> decimal places. <span class="endmark">[1]</span>`, 1, roundTo(eachC/100,2)),
              partInteger("n8_4pc_b", `<b>(b)</b> A garden needs <b>${fmtNo00(reqLargeC/100,2)} kg</b> of compost in large bags and <b>${fmtNo00(reqSmallC/100,2)} kg</b> in small bags.<br>Bags must be bought as whole bags.<br>The <b>TOTAL</b> number of bags bought is shared equally between <b>4</b> gardeners.<br>Work out how many bags <b>EACH</b> gardener receives. <span class="endmark">[3]</span>`, 3, ansBags),
            ]);
          }
        }

        // Scenario 3 (Non-money: fuel planning) — table
        if(!isCalc){
          const city = rng.int(5,9);
          const motorway = rng.int(10,14);
          const rural = rng.int(7,11);
          const short = rng.int(4,7);

          // (a)
          const ruralTrips = rng.int(4,10);
          const ruralLitres = ruralTrips*rural;

          // (b) build total so short trips work out exactly
          const shortTrips = rng.int(6,16);
          const totalFuel = 5*city + 3*motorway + shortTrips*short;

          const table = `
            <table class="qtable">
              <tr><th>Trip type</th><th class="num">Fuel used (litres)</th></tr>
              <tr><td>City</td><td class="num">${city}</td></tr>
              <tr><td>Motorway</td><td class="num">${motorway}</td></tr>
              <tr><td>Rural</td><td class="num">${rural}</td></tr>
              <tr><td>Short</td><td class="num">${short}</td></tr>
            </table>`;

          return Q([
            partInteger("n8_4f_a", `Fuel used per trip is shown.${table}<br><b>(a)</b> <b>${ruralLitres}</b> litres of fuel are used on rural trips only.<br>How many rural trips is that? <span class="endmark">[1]</span>`, 1, ruralTrips),
            partInteger("n8_4f_b", `<b>(b)</b> A driver has <b>${totalFuel}</b> litres of fuel available for the day.<br>They make <b>5</b> city trips and <b>3</b> motorway trips.<br>The fuel left is used for short trips only.<br>Work out how many short trips can be made. <span class="endmark">[3]</span>`, 3, shortTrips),
          ]);
        }else{
          // use hundredths of litres to keep exact
          const cityC = pickPence(650, 900);      // 6.50–9.00 L
          const motorwayC = pickPence(1050, 1500); // 10.50–15.00 L
          const ruralC = pickPence(750, 1250);     // 7.50–12.50 L
          const shortC = pickPence(450, 850);      // 4.50–8.50 L

          const ruralTrips = rng.int(4,10);
          const ruralLitresC = ruralTrips*ruralC;

          const shortTrips = rng.int(6,16);
          const totalFuelC = 5*cityC + 3*motorwayC + shortTrips*shortC;

          const table = `
            <table class="qtable">
              <tr><th>Trip type</th><th class="num">Fuel used (litres)</th></tr>
              <tr><td>City</td><td class="num">${(cityC/100).toFixed(2)}</td></tr>
              <tr><td>Motorway</td><td class="num">${(motorwayC/100).toFixed(2)}</td></tr>
              <tr><td>Rural</td><td class="num">${(ruralC/100).toFixed(2)}</td></tr>
              <tr><td>Short</td><td class="num">${(shortC/100).toFixed(2)}</td></tr>
            </table>`;

          return Q([
            partInteger("n8_4fc_a", `Fuel used per trip is shown.${table}<br><b>(a)</b> <b>${fmtNo00(ruralLitresC/100,2)}</b> litres of fuel are used on rural trips only.<br>How many rural trips is that? <span class="endmark">[1]</span>`, 1, ruralTrips),
            partInteger("n8_4fc_b", `<b>(b)</b> A driver has <b>${fmtNo00(totalFuelC/100,2)}</b> litres of fuel available for the day.<br>They make <b>5</b> city trips and <b>3</b> motorway trips.<br>The fuel left is used for short trips only.<br>Work out how many short trips can be made. <span class="endmark">[3]</span>`, 3, shortTrips),
          ]);
        }
      }

      // -------------------- 5 MARK (TABLE) --------------------
      if(marksTotal===5){
        if(sc===1){
          // Scenario 1 (Money: split + change then split) — table
          if(!isCalc){
            const pay = 200;
            let meal, drink, dessert, side, totalCost, change;
            let guard=0;
            do{
              meal = rng.int(10,18);
              drink = rng.int(2,6);
              dessert = rng.int(3,8);
              side = rng.int(2,6); // not used (kept for table completeness)
              totalCost = 8*meal + 6*drink + 3*dessert;
              change = pay - totalCost;
              guard++;
            }while((change<=0 || change%5!==0) && guard<500);

            const table = `
              <table class="qtable">
                <tr><th>Item</th><th class="num">Cost</th></tr>
                <tr><td>Meal</td><td class="num">£${meal}</td></tr>
                <tr><td>Drink</td><td class="num">£${drink}</td></tr>
                <tr><td>Dessert</td><td class="num">£${dessert}</td></tr>
                <tr><td>Side</td><td class="num">£${side}</td></tr>
              </table>`;

            const eachPays = (8*meal)/4; // = 2*meal
            const eachGets = change/5;

            return Q([
              partMoney("n8_5a", `Prices are shown below.${table}<br><b>(a)</b> A group buys <b>8</b> meals.<br>They share the cost equally between <b>4</b> people.<br>Work out how much <b>EACH</b> person pays. <span class="endmark">[2]</span>`, 2, eachPays),
              partMoney("n8_5b", `<b>(b)</b> The group also buys <b>6</b> drinks and <b>3</b> desserts.<br>They pay with <b>£${pay}</b>.<br>The change is shared equally between <b>5</b> people.<br>Work out how much <b>EACH</b> person gets. <span class="endmark">[3]</span>`, 3, eachGets),
            ]);
          }else{
            const payP = 22000;
            let mealP, drinkP, dessertP, sideP, totalCostP, changeP;
            let guard=0;
            do{
              mealP = pickPence(1000, 1800);
              drinkP = pickPence(250, 700);
              dessertP = pickPence(350, 900);
              sideP = pickPence(250, 800); // table completeness
              totalCostP = 8*mealP + 6*drinkP + 3*dessertP;
              changeP = payP - totalCostP;
              guard++;
            }while((changeP<=0 || changeP%5!==0) && guard<800);

            const table = `
              <table class="qtable">
                <tr><th>Item</th><th class="num">Cost</th></tr>
                <tr><td>Meal</td><td class="num">£${(mealP/100).toFixed(2)}</td></tr>
                <tr><td>Drink</td><td class="num">£${(drinkP/100).toFixed(2)}</td></tr>
                <tr><td>Dessert</td><td class="num">£${(dessertP/100).toFixed(2)}</td></tr>
                <tr><td>Side</td><td class="num">£${(sideP/100).toFixed(2)}</td></tr>
              </table>`;

            const eachPays = roundTo((2*mealP)/100,2);
            const eachGets = roundTo((changeP/5)/100,2);

            return Q([
              partMoney("n8_5ac", `Prices are shown below.${table}<br><b>(a)</b> A group buys <b>8</b> meals.<br>They share the cost equally between <b>4</b> people.<br>Work out how much <b>EACH</b> person pays. Give your answer to <b>2</b> decimal places. <span class="endmark">[2]</span>`, 2, eachPays),
              partMoney("n8_5bc", `<b>(b)</b> The group also buys <b>6</b> drinks and <b>3</b> desserts.<br>They pay with <b>£${fmtNo00(payP/100,2)}</b>.<br>The change is shared equally between <b>5</b> people.<br>Work out how much <b>EACH</b> person gets. Give your answer to <b>2</b> decimal places. <span class="endmark">[3]</span>`, 3, eachGets),
            ]);
          }
        }

        if(sc===2){
          // Scenario 2 (Non-money: volume filling + sharing) — table
          const jugs = isCalc ? rng.choice([6,7,8,9]) : rng.choice([8,9,10,12]);
          const cups = isCalc ? rng.choice([6,7,8,9]) : rng.choice([5,6,7,8,9]);

          if(!isCalc){
            // container volumes (whole numbers) — randomised so ANY container can be the smallest
            const vols = [];
            while(vols.length<4){
              const v = rng.int(3,15);
              if(!vols.includes(v)) vols.push(v);
            }
            const names = ["Container A","Container B","Container C","Container D"];
            const shuffledVols = rng.shuffle(vols);
            const list = names.map((name,i)=>({name, v:shuffledVols[i]}));

            // smallest
            let minObj = list[0];
            for(const o of list){ if(o.v<minObj.v) minObj=o; }
            const vMin = minObj.v;

            const denom = jugs*cups;
            const step = denom / gcd(vMin, denom);
            const fullCount = rng.int(6,14)*step;
            const remainder = rng.int(0, vMin-1);
            const totalWater = fullCount*vMin + remainder;

            const usedWater = fullCount*vMin;
            const eachCup = usedWater/denom;

            const table = `
              <table class="qtable">
                <tr><th>Container type</th><th class="num">Volume (litres)</th></tr>
                ${list.map(o=>`<tr><td>${o.name}</td><td class="num">${o.v}</td></tr>`).join("")}
              </table>`;

            return Q([
              partPair("n8_5v_a", `Drinks are supplied in containers.${table}<br><b>(a)</b> A sports day has <b>${totalWater}</b> litres of water.<br>They pour the water into the smallest volume container.<br>Work out how many <b>FULL</b> containers they can fill and how many litres are left over. <span class="endmark">[2]</span>`, 2, [fullCount, remainder], {placeholders:["Full containers","Litres left over"]}),
              partNumber("n8_5v_b", `<b>(b)</b> Only the water in the <b>FULL</b> containers is used for drinks.<br>This water is shared equally into <b>${jugs}</b> jugs.<br>Then each jug is poured equally into <b>${cups}</b> cups.<br>Work out the volume of water in <b>EACH</b> cup. <span class="endmark">[3]</span>`, 3, eachCup),
            ]);
          }else{
            // calculator version — hundredths of litres (randomised so ANY container can be the smallest)
            let vols = [];
            while(vols.length<4){
              const v = pickPence(250, 1400); // 2.50–14.00
              if(!vols.includes(v)) vols.push(v);
            }
            vols = rng.shuffle(vols);
            const names = ["Container A","Container B","Container C","Container D"];
            const list = names.map((name,i)=>({name, v: vols[i]}));

            let minObj = list[0];
            for(const o of list){ if(o.v<minObj.v) minObj=o; }
            const vMin = minObj.v; // in hundredths of a litre

            const denom = jugs*cups;
            const step = denom / gcd(vMin, denom);
            const fullCount = rng.int(6,14)*step;
            const remainder = rng.int(0, vMin-1);
            const totalWater = fullCount*vMin + remainder;

            const usedWater = fullCount*vMin;
            const eachCup = roundTo((usedWater/denom)/100,2);
            const leftover = roundTo(remainder/100,2);

            const table = `
              <table class="qtable">
                <tr><th>Container type</th><th class="num">Volume (litres)</th></tr>
                ${list.map(o=>`<tr><td>${o.name}</td><td class="num">${(o.v/100).toFixed(2)}</td></tr>`).join("")}
              </table>`;

            return Q([
              partPair("n8_5vc_a", `Drinks are supplied in containers.${table}<br><b>(a)</b> A sports day has <b>${fmtNo00(totalWater/100,2)}</b> litres of water.<br>They pour the water into the smallest volume container.<br>Work out how many <b>FULL</b> containers they can fill and how many litres are left over. Round any decimal answers to <b>2</b> decimal places. <span class="endmark">[2]</span>`, 2, [fullCount, leftover], {placeholders:["Full containers","Litres left over"]}),
              partNumber("n8_5vc_b", `<b>(b)</b> Only the water in the <b>FULL</b> containers is used for drinks.<br>This water is shared equally into <b>${jugs}</b> jugs.<br>Then each jug is poured equally into <b>${cups}</b> cups.<br>Work out the volume of water in <b>EACH</b> cup. Give your answer to <b>2</b> decimal places. <span class="endmark">[3]</span>`, 3, eachCup),
            ]);
          }
        }

        // Scenario 3 (Non-money: sessions + staffing split) — table
        if(!isCalc){
          let swim = rng.choice([40,45,50,55]);
          let fitness = rng.choice([55,60,65]);
          let yoga = rng.choice([35,40,45]);
          let bad = rng.choice([45,50,55]);
          const staff = 7;

          // (a) coach minutes available
          const yogaSessions = rng.int(5,10);
          const remainder = rng.int(0, yoga-1);
          const available = yoga*yogaSessions + remainder;

          // (b) total time shared between staff
          let totalTime = 8*swim + 6*bad;
          let guard=0;
          while(totalTime%staff!==0 && guard<200){
            swim = rng.choice([40,45,50,55]);
            bad = rng.choice([45,50,55]);
            totalTime = 8*swim + 6*bad;
            guard++;
          }
          const eachStaff = totalTime/staff;

          const table = `
            <table class="qtable">
              <tr><th>Session type</th><th class="num">Minutes per session</th></tr>
              <tr><td>Swimming</td><td class="num">${swim}</td></tr>
              <tr><td>Fitness class</td><td class="num">${fitness}</td></tr>
              <tr><td>Yoga</td><td class="num">${yoga}</td></tr>
              <tr><td>Badminton</td><td class="num">${bad}</td></tr>
            </table>`;

          return Q([
            partInteger("n8_5s_a", `A leisure centre runs sessions.${table}<br><b>(a)</b> A coach has <b>${available}</b> minutes available.<br>How many whole yoga sessions can be run? <span class="endmark">[2]</span>`, 2, yogaSessions),
            partInteger("n8_5s_b", `<b>(b)</b> In one day the centre runs <b>8</b> swimming sessions and <b>6</b> badminton sessions.<br>The <b>TOTAL</b> session time is shared equally between <b>${staff}</b> staff to supervise.<br>Work out how many minutes <b>EACH</b> staff member supervises. <span class="endmark">[3]</span>`, 3, eachStaff),
          ]);
        }else{
          // calculator version — hundredths of minutes
          let swimC = pickPence(4000, 6500);    // 40.00–65.00
          let fitnessC = pickPence(5500, 7500); // 55.00–75.00
          let yogaC = pickPence(3500, 5000);    // 35.00–50.00
          let badC = pickPence(4500, 6500);     // 45.00–65.00
          const staff = 7;

          const yogaSessions = rng.int(5,10);
          const remainder = rng.int(0, yogaC-1);
          const availableC = yogaC*yogaSessions + remainder;

          let totalTimeC = 8*swimC + 6*badC;
          let guard=0;
          while(totalTimeC%staff!==0 && guard<400){
            swimC = pickPence(4000, 6500);
            badC = pickPence(4500, 6500);
            totalTimeC = 8*swimC + 6*badC;
            guard++;
          }
          const eachStaff = roundTo((totalTimeC/staff)/100,2);

          const table = `
            <table class="qtable">
              <tr><th>Session type</th><th class="num">Minutes per session</th></tr>
              <tr><td>Swimming</td><td class="num">${(swimC/100).toFixed(2)}</td></tr>
              <tr><td>Fitness class</td><td class="num">${(fitnessC/100).toFixed(2)}</td></tr>
              <tr><td>Yoga</td><td class="num">${(yogaC/100).toFixed(2)}</td></tr>
              <tr><td>Badminton</td><td class="num">${(badC/100).toFixed(2)}</td></tr>
            </table>`;

          return Q([
            partInteger("n8_5sc_a", `A leisure centre runs sessions.${table}<br><b>(a)</b> A coach has <b>${fmtNo00(availableC/100,2)}</b> minutes available.<br>How many whole yoga sessions can be run? <span class="endmark">[2]</span>`, 2, yogaSessions),
            partNumber("n8_5sc_b", `<b>(b)</b> In one day the centre runs <b>8</b> swimming sessions and <b>6</b> badminton sessions.<br>The <b>TOTAL</b> session time is shared equally between <b>${staff}</b> staff to supervise.<br>Work out how many minutes <b>EACH</b> staff member supervises. Give your answer to <b>2</b> decimal places. <span class="endmark">[3]</span>`, 3, eachStaff),
          ]);
        }
      }

      // Fallback (shouldn't be needed)
      return Q([partInteger("n8_f", `Work out: <b>84 ÷ 7</b>. <span class="endmark">[1]</span>`, 1, 12)]);
    }
    case "N9": {
      if(marksTotal===1){
        const a=rng.int(-20,20), b=rng.int(-20,20);
        return Q([partInteger("n9_1", `Work out: <b>${a} − (${b})</b>. <span class="endmark">[1]</span>`, 1, a-b)]);
      }
      if(marksTotal===2){
        const a=rng.int(-30,30), b=rng.int(-30,30), c=rng.int(-15,15);
        return Q([
          partInteger("n9_2a", `Work out: <b>${a} + (${b})</b>. <span class="endmark">[1]</span>`, 1, a+b),
          partInteger("n9_2b", `Work out: <b>${a} + (${b}) − (${c})</b>. <span class="endmark">[1]</span>`, 1, a+b-c),
        ]);
      }
      if(marksTotal===3){
        const a=rng.int(-20,20), b=rng.int(-9,9), c=rng.int(-9,9);
        const ans = a + b*c;
        return Q([partInteger("n9_3", `Work out: <b>${a} + ${b} × ${c}</b>. <span class="endmark">[3]</span>`, 3, ans)]);
      }
      if(marksTotal===4){
        const a=rng.int(-12,12), b=rng.int(-12,12), c=rng.int(2,8), d=rng.int(-9,9);
        const ans = (a-b)*c + d;
        return Q([partInteger("n9_4", `Work out: <b>(${a} − ${b}) × ${c} + (${d})</b>. <span class="endmark">[4]</span>`, 4, ans)]);
      }
      // 5 marks: two linked negative steps, mark structure
      const start=rng.int(-50,50);
      const change1=rng.int(-30,30);
      const change2=rng.int(-30,30);
      const final = start + change1 - change2;
      return Q([
        partInteger("n9_5a", `Start at <b>${start}</b>. Add <b>${change1}</b>. Work out the result <span class="endmark">[2]</span>`, 2, start+change1),
        partInteger("n9_5b", `Now subtract <b>${change2}</b>. Work out the final result <span class="endmark">[3]</span>`, 3, final),
      ]);
    }
    /* SPLITMERGE:BUILDQUESTION-CASES-END */

    default:
      return Q([partNumber("x", `Not implemented. <span class="endmark">[${marksTotal}]</span>`, marksTotal, 0)]);
  }
}

// SECTION: Rendering + inputs
// - Builds the per-question HTML (question text, answer inputs, mark buttons).
// - Installs widget behaviour for:
//   • standard form EXP entry (single input)
//   • drag-and-drop ordering tiles
//   • numeric/text answer validation
const topicSel = document.getElementById("topicSel");
const marksSel = document.getElementById("marksSel");
const calcSel  = document.getElementById("calcSel");
const preview  = document.getElementById("preview");
const fb       = document.getElementById("fb");

const regenBtn = document.getElementById("regenBtn");
const checkBtn = document.getElementById("checkBtn");
const revealBtn= document.getElementById("revealBtn");

let current = null;

function initTopicDropdown(){
  TOPICS.forEach(t=>{
    const o=document.createElement("option");
    o.value=t.code;
    o.textContent=`${t.code} — ${t.name}`;
    topicSel.appendChild(o);
  });
  topicSel.value = "N7"; // default: simplify fractions (a commonly tested topic)
}

function paperTagHtml(paperMode){
  return paperMode==="calc"
    ? `<span class="nc-tag calc">CALCULATOR</span>`
    : `<span class="nc-tag nc">NON‑CALCULATOR</span>`;
}

function renderInput(input, answerType, baseId){
  if (!input) return "";
  const kind = input.kind;

  if (kind==="fraction" || answerType==="fraction"){
    return `
      <span class="frac" aria-label="fraction answer">
        <input id="${baseId}N" class="mini" type="text" inputmode="numeric" placeholder="numerator" />
        <span class="bar"></span>
        <input id="${baseId}D" class="mini" type="text" inputmode="numeric" placeholder="denominator" />
      </span>
    `;
  }

  if (kind==="pair"){
    const lab0 = input.labels?.[0];
    const lab1 = input.labels?.[1];
    const ph0 = input.placeholders?.[0]||"a";
    const ph1 = input.placeholders?.[1]||"b";
    const labelHtml = (t)=> t ? `<span style="font-weight:900;color:#111827">${t}</span>` : "";
    return `
      <span class="twobox" aria-label="two answers">
        ${labelHtml(lab0)}
        <input id="${baseId}A" class="mini" type="text" inputmode="decimal" placeholder="${ph0}" />
        ${labelHtml(lab1)}
        <input id="${baseId}B" class="mini" type="text" inputmode="decimal" placeholder="${ph1}" />
      </span>
    `;
  }

  if (kind==="triple"){
    return `
      <span class="threebox" aria-label="three answers">
        <input id="${baseId}A" class="mini" type="text" inputmode="decimal" placeholder="${input.placeholders?.[0]||"a"}" />
        <input id="${baseId}B" class="mini" type="text" inputmode="decimal" placeholder="${input.placeholders?.[1]||"b"}" />
        <input id="${baseId}C" class="mini" type="text" inputmode="decimal" placeholder="${input.placeholders?.[2]||"c"}" />
      </span>
    `;
  }

  if (kind==="standardForm" || answerType==="standardForm"){
    // Single entry box only. Press EXP to insert ×10 and then type the power as a superscript.
    return `
      <div class="sfwrap" aria-label="standard form answer">
        <input id="${baseId}" class="sfinput" type="text" inputmode="decimal" placeholder="e.g. 3.2×10⁵" autocomplete="off" />
        <div class="keypad sfctrl" data-sf-target="${baseId}">
          <button class="kbtn accent" data-act="exp">EXP</button>
          <button class="kbtn" data-act="neg">±</button>
          <button class="kbtn" data-act="bksp">⌫</button>
          <button class="kbtn" data-act="clear">Clear</button>
        </div>
        <div class="sfhint">Type the number. Press <b>EXP</b> to insert <b>×10</b> with a superscript power.</div>
      </div>
    `;
  }


  if (kind==="primeFactors" || answerType==="primeFactors"){
    // Visual box + hidden canonical string (uses ^ internally, never shown)
    return `
      <div class="pfwrap" aria-label="prime factorisation answer">
        <div class="pfbox" id="${baseId}Box" tabindex="0" aria-label="prime factorisation input"></div>
        <input id="${baseId}" type="hidden" value="" />
        <div class="keypad" data-target="${baseId}" data-exp="0">
          <button class="kbtn" data-prime="2">2</button>
          <button class="kbtn" data-prime="3">3</button>
          <button class="kbtn" data-prime="5">5</button>
          <button class="kbtn" data-prime="7">7</button>
          <button class="kbtn" data-prime="11">11</button>
          <button class="kbtn primary" data-ins="×">×</button>

          <button class="kbtn" data-act="exp" aria-pressed="false">EXP</button>
          <button class="kbtn" data-digit="1">1</button>
          <button class="kbtn" data-digit="2">2</button>
          <button class="kbtn" data-digit="3">3</button>
          <button class="kbtn" data-digit="4">4</button>
          <button class="kbtn" data-digit="5">5</button>

          <button class="kbtn" data-digit="6">6</button>
          <button class="kbtn" data-digit="7">7</button>
          <button class="kbtn" data-digit="8">8</button>
          <button class="kbtn" data-digit="9">9</button>
          <button class="kbtn" data-digit="0">0</button>
          <button class="kbtn" data-act="bksp">⌫</button>

          <button class="kbtn danger" data-act="clear" style="grid-column:1 / span 6">Clear</button>
        </div>
      </div>
    `;
  }

  

  if (kind==="order" || answerType==="order"){
    // Drag-order widgets render inside the question text; nothing to render here.
    return ``;
  }
if (kind==="money"){
    return `<input id="${baseId}" type="text" inputmode="decimal" placeholder="£" style="min-width:140px" />`;
  }

  if (kind==="int" || kind==="integer"){

    return `<input id="${baseId}" type="text" inputmode="numeric" placeholder="answer" style="min-width:140px" />`;
  }

  return `<input id="${baseId}" type="text" inputmode="decimal" placeholder="answer" style="min-width:160px" />`;
}

function renderQuestion(q){
  const topicName = TOPICS.find(t=>t.code===q.topicCode)?.name ?? q.topicCode;
  const title = `${q.topicCode} — ${topicName}`;
  const badge = `<span class="badge">[${q.marksTotal} mark${q.marksTotal===1?"":"s"}]</span>`;

  const itemsHtml = q.parts.map((p,idx)=>{
    const inputHtml = renderInput(p.input, p.answer?.type, p.input?.id || `p${idx}`);
    const rawText = (p.textHtml ?? "");

    const hasInput = Boolean(inputHtml && String(inputHtml).trim() !== "");
    if(!hasInput){
      return `
        <div class="item">
          <div class="qtext">${rawText}</div>
        </div>
      `;
    }

    // If the question part contains a table, render the table full-width ABOVE the answer line.
    // This keeps the answer box horizontally aligned with the part (a)/(b) text rather than the top of the table.
    const m = rawText.match(/([\s\S]*?)(<table\s+class="qtable"[\s\S]*?<\/table>)([\s\S]*)/i);

    if(m){
      const before = m[1] ?? "";
      const tableHtml = m[2] ?? "";
      let after = m[3] ?? "";
      // remove leading <br> tags so the (a)/(b) line sits at the top next to the answer box
      after = after.replace(/^\s*(?:<br\s*\/?>\s*)+/i, "");

      return `
        <div class="item">
          <div class="qtext">${before}${tableHtml}</div>
          <div class="line">
            <div class="qtext">${after}</div>
            <div>${inputHtml}</div>
          </div>
        </div>
      `;
    }

    return `
      <div class="item">
        <div class="line">
          <div class="qtext">${rawText}</div>
          <div>${inputHtml}</div>
        </div>
      </div>
    `;
  }).join("");

  preview.innerHTML = `
    <div class="qpanel">
      <div class="qhead">
        <h3>${title} ${badge}</h3>
        ${paperTagHtml(q.paperMode)}
      </div>
      <div class="qbody">
        ${itemsHtml}
      </div>
    </div>
    
  `;

  initDragOrders();

  fb.style.display="none";
  fb.className="feedback";
  fb.textContent="";
}


// SECTION: Drag-and-drop ordering (integers/decimals/fractions)
// - Tiles can be dragged from the bank into drop boxes.
// - The student's order is stored as JSON in a hidden <input>.
// - Check logic reads and compares the stored order to the expected token list.
let dragState = {box:null, widget:null};
let clickPick = null;

function syncDragOrder(widget){
  if(!widget) return;
  const hidden = widget.querySelector('input[type="hidden"]');
  const drops = Array.from(widget.querySelectorAll(".dropbox"));
  const arr = drops.map(d=>d.querySelector(".dragbox")?.dataset.token ?? null);
  if(hidden) hidden.value = JSON.stringify(arr);
}

function initDragOrders(){
  if(clickPick && clickPick.classList) clickPick.classList.remove("selected");
  clickPick = null;
  preview.querySelectorAll(".drag-order").forEach(w=>syncDragOrder(w));
}

function placeDragBox(box, target){
  if(!box || !target) return;
  const widget = box.closest(".drag-order");
  if(!widget) return;
  const bank = widget.querySelector(".drag-bank");
  if(!bank) return;

  if(target.classList.contains("dropbox")){
    const existing = target.querySelector(".dragbox");
    const srcParent = box.parentElement;
    if(existing && existing!==box){
      if(srcParent && srcParent.classList.contains("dropbox")){
        srcParent.appendChild(existing);
      } else {
        bank.appendChild(existing);
      }
    }
    target.appendChild(box);
  } else if(target.classList.contains("drag-bank")){
    target.appendChild(box);
  }
  syncDragOrder(widget);
}

preview.addEventListener("dragstart", (e)=>{
  const box = e.target.closest(".dragbox");
  if(!box) return;
  const widget = box.closest(".drag-order");
  if(!widget) return;
  dragState.box = box;
  dragState.widget = widget;
  box.classList.add("dragging");
  try{
    e.dataTransfer.setData("text/plain", box.dataset.token || box.textContent || "");
    e.dataTransfer.effectAllowed = "move";
  }catch(err){}
});

preview.addEventListener("dragend", (e)=>{
  const box = e.target.closest(".dragbox");
  if(box) box.classList.remove("dragging");
  preview.querySelectorAll(".dropbox.over").forEach(el=>el.classList.remove("over"));
  dragState.box = null;
  dragState.widget = null;
});

preview.addEventListener("dragover", (e)=>{
  const target = e.target.closest(".dropbox, .drag-bank");
  if(!target) return;
  const widget = target.closest(".drag-order");
  if(!widget || widget !== dragState.widget) return;
  e.preventDefault();
  if(target.classList.contains("dropbox")) target.classList.add("over");
});

preview.addEventListener("dragleave", (e)=>{
  const target = e.target.closest(".dropbox");
  if(target) target.classList.remove("over");
});

preview.addEventListener("drop", (e)=>{
  const target = e.target.closest(".dropbox, .drag-bank");
  if(!target) return;
  const widget = target.closest(".drag-order");
  if(!widget || widget !== dragState.widget) return;
  e.preventDefault();
  target.classList.remove("over");
  if(dragState.box){
    placeDragBox(dragState.box, target);
  }
});

// Tap/click fallback (mobile): tap a box to pick it up, then tap a target.
preview.addEventListener("click", (e)=>{
  const box = e.target.closest(".dragbox");
  const widget = e.target.closest(".drag-order");
  if(box && widget){
    if(clickPick === box){
      box.classList.remove("selected");
      clickPick = null;
    } else {
      if(clickPick) clickPick.classList.remove("selected");
      clickPick = box;
      box.classList.add("selected");
    }
    return;
  }

  const target = e.target.closest(".dropbox, .drag-bank");
  if(target && clickPick){
    const w2 = target.closest(".drag-order");
    const w1 = clickPick.closest(".drag-order");
    if(w1 && w2 && w1===w2){
      placeDragBox(clickPick, target);
    }
    clickPick.classList.remove("selected");
    clickPick = null;
  }
});

/* -------------------- standard form input (EXP -> superscript) -------------------- */
const SF_SUP = {
  "0":"⁰","1":"¹","2":"²","3":"³","4":"⁴","5":"⁵","6":"⁶","7":"⁷","8":"⁸","9":"⁹",
  "-":"⁻","+":"⁺"
};
const SF_UNSUP = {
  "⁰":"0","¹":"1","²":"2","³":"3","⁴":"4","⁵":"5","⁶":"6","⁷":"7","⁸":"8","⁹":"9",
  "⁻":"-","⁺":"+"
};

function sfEscapeHtml(s){
  return String(s??"")
    .replace(/&/g,"&amp;")
    .replace(/</g,"&lt;")
    .replace(/>/g,"&gt;");
}
function sfUnsupAll(s){
  return String(s??"").replace(/[⁰¹²³⁴⁵⁶⁷⁸⁹⁻⁺]/g, ch => (SF_UNSUP[ch] ?? ch));
}
function sfSupDigits(s){
  return String(s??"").replace(/[0-9\-\+]/g, ch => (SF_SUP[ch] ?? ch));
}

function sfToHTML(raw){
  const s0 = String(raw ?? "").trim();
  if(!s0) return "";
  const plain = sfUnsupAll(s0).replace(/\s+/g,"");

  // Display E-notation as ×10^n.
  let m = plain.match(/^([+-]?(?:\d+(?:\.\d+)?|\.\d+))[eE]([+-]?\d*)$/);
  if(m){
    const A = m[1] ?? "";
    const n = m[2] ?? "";
    return `${sfEscapeHtml(A)}<span class="mul">×</span>10<sup>${sfEscapeHtml(n || "□")}</sup>`;
  }

  // Display A×10n or A×10^n (caret optional)
  m = plain.match(/^([+-]?(?:\d+(?:\.\d+)?|\.\d+))(?:×|x|\*)10\^?([+-]?\d*)$/i);
  if(m){
    const A = m[1] ?? "";
    const n = m[2] ?? "";
    return `${sfEscapeHtml(A)}<span class="mul">×</span>10<sup>${sfEscapeHtml(n || "□")}</sup>`;
  }

  // Fallback: show as typed (still replaces × with styled ×).
  return sfEscapeHtml(s0).replace(/×/g, `<span class="mul">×</span>`);
}

function sfSyncPreview(targetId){
  const el = document.getElementById(targetId);
  const box = document.getElementById(targetId+"Box");
  if(!el || !box) return;
  box.innerHTML = sfToHTML(el.value);
}

function sfSetCaretEnd(el){
  try{
    const n = el.value.length;
    el.setSelectionRange(n, n);
  }catch(err){}
}

function sfEnsureTen(v){
  v = String(v ?? "");
  if(/(?:×|x|\*)10/.test(v)) return v;
  if(v==="" || v==="-") v = (v==="-") ? "-1" : "1";
  return v + "×10";
}

function sfGetExpPart(v){
  const m = String(v ?? "").match(/(?:×|x|\*)10(.*)$/);
  return m ? (m[1] ?? "") : "";
}

function sfToggleMantissaSign(v){
  v = String(v ?? "");
  if(v.startsWith("-")) return v.slice(1);
  return v ? "-" + v : "-";
}

function sfToggleExponentSign(v){
  v = String(v ?? "");
  const m = v.match(/^(.*?)(?:×|x|\*)10(.*)$/);
  if(!m) return sfToggleMantissaSign(v);

  const head = m[1] ?? "";
  const expRaw = m[2] ?? "";
  const expPlain = sfUnsupAll(expRaw);

  let outPlain = expPlain;
  if(outPlain.startsWith("-")) outPlain = outPlain.slice(1);
  else outPlain = "-" + outPlain.replace(/^\+/, "");

  const outSup = sfSupDigits(outPlain);
  return head + "×10" + outSup;
}

function sfBackspace(v){
  v = String(v ?? "");
  if(!v) return "";

  const last = v.slice(-1);
  if(typeof SF_UNSUP[last] !== "undefined"){
    // delete superscript digit/sign
    v = v.slice(0,-1);
    return v;
  }

  if(v.endsWith("×10")) return v.slice(0,-3);
  return v.slice(0,-1);
}

// Keep the preview in sync while typing
preview.addEventListener("input", (e)=>{
  const el = e.target;
  if(!(el instanceof HTMLInputElement)) return;
  if(!el.classList.contains("sfinput")) return;

  // If the user deletes the ×10 part, cancel EXP mode
  if(el.dataset.sfExp === "1" && !/(?:×|x|\*)10/.test(el.value)){
    el.dataset.sfExp = "0";
    const ctrl = preview.querySelector(`.sfctrl[data-sf-target="${el.id}"]`);
    const expBtn = ctrl ? ctrl.querySelector('button[data-act="exp"]') : null;
    if(expBtn){
      expBtn.classList.remove("on");
      expBtn.setAttribute("aria-pressed","false");
    }
  }

  sfSyncPreview(el.id);
});

// Keyboard typing: when EXP is ON, digits become superscripts (no E and no caret notation).
preview.addEventListener("keydown", (e)=>{
  const el = e.target;
  if(!(el instanceof HTMLInputElement)) return;
  if(!el.classList.contains("sfinput")) return;
  if(el.dataset.sfExp !== "1") return;

  const key = e.key;

  // Always keep typing at the end while EXP is on
  if(key==="ArrowLeft" || key==="ArrowRight" || key==="Home" || key==="End"){
    e.preventDefault();
    sfSetCaretEnd(el);
    return;
  }

  if(key==="Backspace"){
    e.preventDefault();
    const nv = sfBackspace(el.value);
    el.value = nv;
    sfSyncPreview(el.id);
    sfSetCaretEnd(el);

    // If we removed the ×10 part, also turn EXP off
    if(!/(?:×|x|\*)10/.test(el.value)){
      el.dataset.sfExp = "0";
      const ctrl = preview.querySelector(`.sfctrl[data-sf-target="${el.id}"]`);
      const expBtn = ctrl ? ctrl.querySelector('button[data-act="exp"]') : null;
      if(expBtn){
        expBtn.classList.remove("on");
        expBtn.setAttribute("aria-pressed","false");
      }
    }
    return;
  }

  if(/^[0-9]$/.test(key) || key==="-" || key==="+"){
    e.preventDefault();
    let v = sfEnsureTen(el.value);

    const expRaw = sfGetExpPart(v);
    const expPlain = sfUnsupAll(expRaw);

    // Only allow +/− as the FIRST exponent character
    if((key==="-" || key==="+") && expPlain.length>0) return;

    v += SF_SUP[key] ?? key;
    el.value = v;
    sfSyncPreview(el.id);
    sfSetCaretEnd(el);
    return;
  }
});

// Buttons (EXP / ± / ⌫ / Clear)
preview.addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;

  const ctrl = btn.closest(".sfctrl");
  if(!ctrl) return;

  e.preventDefault();

  const targetId = ctrl.dataset.sfTarget;
  const el = document.getElementById(targetId);
  if(!el) return;

  const act = btn.dataset.act;

  if(act==="clear"){
    el.value = "";
    el.dataset.sfExp = "0";
    btn.classList.remove("on");
    btn.setAttribute("aria-pressed","false");
    sfSyncPreview(targetId);
    el.focus();
    return;
  }

  if(act==="bksp"){
    const nv = sfBackspace(el.value);
    el.value = nv;
    sfSyncPreview(targetId);
    sfSetCaretEnd(el);

    if(!/(?:×|x|\*)10/.test(el.value)){
      el.dataset.sfExp = "0";
      const expBtn = ctrl.querySelector('button[data-act="exp"]');
      if(expBtn){
        expBtn.classList.remove("on");
        expBtn.setAttribute("aria-pressed","false");
      }
    }

    el.focus();
    return;
  }

  if(act==="exp"){
    const expBtn = ctrl.querySelector('button[data-act="exp"]');
    const on = !(el.dataset.sfExp === "1");
    el.dataset.sfExp = on ? "1" : "0";
    if(expBtn){
      expBtn.classList.toggle("on", on);
      expBtn.setAttribute("aria-pressed", on ? "true" : "false");
    }

    if(on){
      el.value = sfEnsureTen(el.value);
      // Do NOT insert ^ or E. Exponent digits will be added as superscripts.
      sfSetCaretEnd(el);
    }

    sfSyncPreview(targetId);
    el.focus();
    return;
  }

  if(act==="neg"){
    // If there is a ×10 part, toggle the exponent sign. Otherwise toggle the mantissa sign.
    if(/(?:×|x|\*)10/.test(el.value)){
      el.value = sfToggleExponentSign(el.value);
    }else{
      el.value = sfToggleMantissaSign(el.value);
    }
    sfSyncPreview(targetId);
    sfSetCaretEnd(el);
    el.focus();
    return;
  }
});

/* -------------------- keypad for prime factors (exp / × / primes) -------------------- */
function pfToHTML(expr){
  if(!expr) return "";
  const parts = String(expr).split("×");
  let out = "";
  for(let i=0;i<parts.length;i++){
    const tok = parts[i];
    if(tok){
      if(tok.includes("^")){
        const [base, exp] = tok.split("^");
        out += `${base}<sup>${exp||""}</sup>`;
      }else{
        out += tok;
      }
    }
    if(i < parts.length-1){
      out += `<span class="mul">×</span>`;
    }
  }
  return out;
}

function pfSetValue(targetId, newVal){
  const hidden = document.getElementById(targetId);
  const box = document.getElementById(targetId+"Box");
  if(!hidden || !box) return;
  hidden.value = newVal;
  box.innerHTML = pfToHTML(newVal);
}

function pfBackspace(expr){
  if(!expr) return "";
  let s = String(expr);
  if(s.endsWith("×")) return s.slice(0,-1);

  const parts = s.split("×");
  if(parts.length===0) return "";
  let last = parts[parts.length-1] || "";

  if(last.includes("^")){
    let [base, exp] = last.split("^");
    exp = exp || "";
    if(exp.length<=1){
      last = base;
    }else{
      last = base + "^" + exp.slice(0,-1);
    }
    parts[parts.length-1] = last;
    return parts.join("×");
  }

  last = last.slice(0,-1);
  if(last===""){
    parts.pop();
    return parts.join("×");
  }
  parts[parts.length-1] = last;
  return parts.join("×");
}

preview.addEventListener("click", (e)=>{
  const btn = e.target.closest("button");
  if(!btn) return;

  const pad = btn.closest(".keypad");
  if(!pad) return;

  e.preventDefault();

  const target = pad.dataset.target;
  const hidden = document.getElementById(target);
  const box = document.getElementById(target+"Box");
  if(!hidden || !box) return;

  const expBtn = pad.querySelector('button[data-act="exp"]');
  const setExp = (on)=>{
    pad.dataset.exp = on ? "1" : "0";
    if(expBtn){
      expBtn.classList.toggle("on", on);
      expBtn.setAttribute("aria-pressed", on ? "true" : "false");
    }
  };

  const isExp = pad.dataset.exp === "1";
  let val = hidden.value || "";

  const act = btn.dataset.act;
  const prime = btn.dataset.prime;
  const digit = btn.dataset.digit;
  const ins = btn.dataset.ins;

  if(act==="clear"){
    pfSetValue(target, "");
    setExp(false);
    return;
  }
  if(act==="bksp"){
    const nv = pfBackspace(val);
    pfSetValue(target, nv);
    // keep exp mode as-is
    return;
  }
  if(act==="exp"){
    if(!val || val.endsWith("×")){ setExp(false); return; }
    setExp(!isExp);
    return;
  }

  if(ins==="×"){
    setExp(false);
    if(!val) return;
    if(val.endsWith("×")) return;
    pfSetValue(target, val + "×");
    return;
  }

  if(prime){
    setExp(false);
    if(val && !val.endsWith("×")) val += "×";
    pfSetValue(target, val + prime);
    return;
  }

  if(typeof digit !== "undefined"){
    if(pad.dataset.exp !== "1") return;
    if(!val || val.endsWith("×")) return;

    const parts = val.split("×");
    let last = parts[parts.length-1] || "";
    if(!last) return;

    let base = last, exp = "";
    if(last.includes("^")){
      [base, exp] = last.split("^");
      exp = exp || "";
    }
    if(exp==="" && digit==="0") return; // no leading zero exponent
    exp += digit;
    parts[parts.length-1] = base + "^" + exp;
    pfSetValue(target, parts.join("×"));
    return;
  }
});

/* -------------------- Answer retrieval -------------------- */
function clearMarks(){
  // remove ok/bad classes from inputs + drag-order tiles
  preview.querySelectorAll("input,select,.dropbox,.dragbox").forEach(el=>{
    el.classList.remove("ok","bad");
  });
}
function markEl(el, ok){
  if(!el) return;
  el.classList.remove("ok","bad");
  el.classList.add(ok ? "ok" : "bad");
}
function getUserAnswerForPart(part){
  const id = part.input?.id;
  const type = part.answer?.type;

  if (part.input?.kind==="order" || type==="order"){
    const hidden = document.getElementById(id);
    const widget = preview.querySelector(`.drag-order[data-drag-order="${id}"]`);
    const drops = widget ? Array.from(widget.querySelectorAll(".dropbox")) : [];

    let arr = null;
    if(hidden && hidden.value){
      try{ arr = JSON.parse(hidden.value); }catch{ arr = null; }
    }
    if(!Array.isArray(arr) && drops.length){
      arr = drops.map(d=>d.querySelector(".dragbox")?.dataset.token ?? null);
    }
    if(!Array.isArray(arr)){
      return {ok:false, val:null, els:drops.length?drops:[hidden].filter(Boolean)};
    }

    const filled = arr.every(x=>x!==null && x!=="" && typeof x!=="undefined");
    return {ok:filled, val:arr, els:drops.length?drops:[hidden].filter(Boolean)};
  }

  if (part.input?.kind==="fraction" || type==="fraction"){
    const nEl = document.getElementById(id+"N");
    const dEl = document.getElementById(id+"D");
    const n = Number(nEl?.value);
    const d = Number(dEl?.value);
    if(!Number.isFinite(n)||!Number.isFinite(d)||d===0) return {ok:false, val:null, els:[nEl,dEl]};
    return {ok:true, val:{n, d}, els:[nEl,dEl]};
  }

  if (part.input?.kind==="pair" || type==="pair"){
    const aEl = document.getElementById(id+"A");
    const bEl = document.getElementById(id+"B");
    const a = asNum(aEl?.value);
    const b = asNum(bEl?.value);
    if(!Number.isFinite(a)||!Number.isFinite(b)) return {ok:false, val:null, els:[aEl,bEl]};
    return {ok:true, val:[a,b], els:[aEl,bEl]};
  }

  if (part.input?.kind==="standardForm" || type==="standardForm"){
    const el = document.getElementById(id);
    const parsed = parseStandardFormInput(el?.value);
    if(!parsed.ok || !Number.isFinite(parsed.A) || !Number.isFinite(parsed.n)) return {ok:false, val:null, els:[el]};
    return {ok:true, val:{A: parsed.A, n: parsed.n}, els:[el]};
  }

  if (part.input?.kind==="primeFactors" || type==="primeFactors"){
    const el = document.getElementById(id);
    const raw = (el?.value ?? "").trim();
    if(!raw) return {ok:false, val:null, els:[el]};
    return {ok:true, val:raw, els:[el]};
  }

  if (part.input?.kind==="symbol" || type==="symbol"){
    const el = document.getElementById(id);
    const v = (el?.value ?? "").trim();
    if(!v) return {ok:false, val:null, els:[el]};
    return {ok:true, val:v, els:[el]};
  }

  if (part.input?.kind==="time" || type==="time"){
    const el = document.getElementById(id);
    const v = (el?.value ?? "").trim();
    if(!v) return {ok:false, val:null, els:[el]};
    return {ok:true, val:v, els:[el]};
  }

  if (part.input?.kind==="integer"){
    const el = document.getElementById(id);
    const raw = (el?.value ?? "").trim();
    const x = asNum(raw);
    if(!Number.isFinite(x) || !Number.isInteger(x)) return {ok:false, val:null, els:[el]};
    return {ok:true, val:x, raw, els:[el]};
  }

  const el = document.getElementById(id);
  const raw = (el?.value ?? "").trim();
  const x = asNum(raw);
  if(!Number.isFinite(x)) return {ok:false, val:null, els:[el]};
  return {ok:true, val:x, raw, els:[el]};
}



/* -------------------- prime-factor answer parsing -------------------- */
function parsePrimeFactorString(raw){
  // Accept forms like: 2^3×3×5^2  or 2*2*2*3*25 etc
  // Reject plain "2475" with no × or ^ (not a factorisation).
  const s = raw.replace(/\s+/g,"")
               .replace(/x/gi,"×")
               .replace(/\*/g,"×")
               .replace(/\./g,"×"); // allow dot as multiply
  const hasSep = s.includes("×") || s.includes("^");
  if(!hasSep) return {ok:false, map:null};

  const parts = s.split("×").filter(Boolean);
  if(parts.length===0) return {ok:false, map:null};

  const map = {};
  for(const tok of parts){
    if(tok==="1" || tok==="+1") return {ok:false, map:null}; // disallow 1 as factor
    // exponent form p^e
    if(tok.includes("^")){
      const m = tok.match(/^(\d+)\^(\d+)$/);
      if(!m) return {ok:false, map:null};
      const p = Number(m[1]), e = Number(m[2]);
      if(!(Number.isInteger(p)&&Number.isInteger(e)&&p>=2&&e>=1)) return {ok:false, map:null};
      const f = factorise(p);
      // base should be prime ideally; but allow composite base (we factor it)
      for(const k of Object.keys(f)){
        map[k] = (map[k]||0) + f[k]*e;
      }
    } else {
      // integer factor (prime or composite)
      const v = Number(tok);
      if(!Number.isInteger(v) || v<2) return {ok:false, map:null};
      const f = factorise(v);
      for(const k of Object.keys(f)){
        map[k] = (map[k]||0) + f[k];
      }
    }
  }
  return {ok:true, map};
}

/* -------------------- marking -------------------- */
function markCurrent(){
  if(!current) return;

  clearMarks();

  const dpUsedFromRaw = (raw)=>{
    const s = String(raw ?? "").trim().replace(/,/g, "");
    if(!s || !s.includes(".")) return 0;
    let frac = s.split(".")[1] ?? "";
    frac = frac.replace(/0+$/g, "");
    return frac.length;
  };

  let score = 0;
  let max = current.marksTotal;

  for(const part of current.parts){
    const expected = part.answer;
    const got = getUserAnswerForPart(part);
    const pm = part.marks ?? 0;

    // Rounded-number marking with partial credit (deduct 1 mark for rounding issues).
    if(expected && expected.type==="rounded"){
      let partScore = 0;

      if(Boolean(got.ok) && Number.isFinite(got.val)){
        const dp = Number(expected.dp);
        const correct = Number(expected.value);
        const unit = Math.pow(10, -dp);

        const roundsToCorrect = close(roundTo(got.val, dp), correct, Math.max(1e-9, unit/1000));
        const withinOneUnit = Math.abs(got.val - correct) <= (unit + 1e-9);

        if(roundsToCorrect){
          const dpUsed = dpUsedFromRaw(got.raw);
          const roundedDone = dpUsed <= dp;
          partScore = roundedDone ? pm : Math.max(0, pm - 1);
        } else if(withinOneUnit){
          partScore = Math.max(0, pm - 1);
        } else {
          partScore = 0;
        }

        if(got.els && got.els.length){
          // Green highlight only for full-credit rounding.
          got.els.forEach(el=>markEl(el, partScore===pm));
        }
      } else {
        if(got.els && got.els.length) got.els.forEach(el=>markEl(el,false));
        partScore = 0;
      }

      score += partScore;
      continue;
    }

    // Drag-order marking (2 marks in the higher-order questions).
    if(expected && expected.type==="order"){
      const correct = Array.isArray(expected.value) ? expected.value : [];
      const user = Array.isArray(got.val) ? got.val : [];
      let partScore = 0;

      if(user.length === correct.length && got.els && got.els.length){
        let correctCount = 0;

        got.els.forEach((el,i)=>{
          const posOk = Boolean(got.ok) && (user[i] === correct[i]);
          if(posOk) correctCount++;
          markEl(el, posOk);
        });

        if(Boolean(got.ok) && correctCount === correct.length){
          partScore = pm;
        } else if(Boolean(got.ok) && pm>=2 && correctCount >= Math.ceil(correct.length/2)){
          partScore = 1; // partial credit
        } else {
          partScore = 0;
        }
      } else {
        if(got.els && got.els.length) got.els.forEach(el=>markEl(el,false));
        partScore = 0;
      }

      score += partScore;
      continue;
    }

    if(expected && expected.type==="pair"){
      // Pair inputs: award full marks if both correct.
      // If the part is worth 2+ marks, award 1 mark for one correct entry.
      let partScore = 0;

      if(Boolean(got.ok) && Array.isArray(got.val) && got.val.length===2){
        const okA = close(got.val[0], expected.value[0], 1e-6);
        const okB = close(got.val[1], expected.value[1], 1e-6);

        if(got.els && got.els.length>=2){
          markEl(got.els[0], okA);
          markEl(got.els[1], okB);
        } else if(got.els && got.els.length){
          got.els.forEach(el=>markEl(el, okA && okB));
        }

        const correctCount = (okA?1:0) + (okB?1:0);

        if(correctCount === 2){
          partScore = pm;
        } else if(pm>=2 && correctCount === 1){
          partScore = 1; // partial credit
        } else {
          partScore = 0;
        }
      } else {
        if(got.els && got.els.length) got.els.forEach(el=>markEl(el,false));
        partScore = 0;
      }

      score += partScore;
      continue;
    }


    if(expected && expected.type==="rounded"){
      // Rounding questions:
      // full marks for the correctly rounded answer
      // if rounding is wrong but the value is within ±1 of the last required decimal place, deduct 1 mark
      let partScore = 0;

      if(Boolean(got.ok)){
        const target = Number(expected.value);
        const dpReq = Number(expected.dp);
        const tol = Math.max(1e-9, Math.abs(target)*1e-8);
        const unit = Number.isFinite(dpReq) ? Math.pow(10, -dpReq) : 0;

        const fullOk = close(got.val, target, tol);
        const nearOk = Number.isFinite(unit) && Math.abs(got.val - target) <= (unit + tol);

        if(fullOk){
          partScore = pm;
        } else if(pm>=2 && nearOk){
          partScore = pm - 1;
        } else {
          partScore = 0;
        }

        // Mark UI elements (green only if fully correct)
        if(got.els && got.els.length){
          got.els.forEach(el=>markEl(el, fullOk));
        }
      } else {
        if(got.els && got.els.length) got.els.forEach(el=>markEl(el,false));
        partScore = 0;
      }

      score += partScore;
      continue;
    }

    let ok = false;

    if(!got.ok){
      ok = false;
    } else if(expected.type==="fraction"){
      ok = fracEq(got.val, expected.value);
    } else if(expected.type==="pair"){
      ok = close(got.val[0], expected.value[0], 1e-6) && close(got.val[1], expected.value[1], 1e-6);
    } else if(expected.type==="standardForm"){
      // require standard form: 1 ≤ A < 10 and integer n
      const A = got.val.A;
      const n = got.val.n;
      const userVal = A * (10**n);
      const targetVal = expected.value;
      ok = Number.isFinite(userVal) && Number.isFinite(A) && Number.isInteger(n) && A>=1 && A<10 &&
           close(userVal, targetVal, Math.max(1e-9, Math.abs(targetVal)*1e-8));
    } else if(expected.type==="primeFactors"){
      const parsed = parsePrimeFactorString(got.val);
      ok = parsed.ok && mapsEqual(parsed.map, expected.value);
    } else if(expected.type==="symbol"){
      ok = got.val === expected.value;
    } else if(expected.type==="time"){
      ok = String(got.val).trim() === String(expected.value).trim();
    } else {
      // number
      ok = close(got.val, expected.value, Math.max(1e-9, Math.abs(expected.value)*1e-8));
    }

    // Mark UI elements
    if(got.els && got.els.length){
      got.els.forEach(el=>markEl(el, ok));
    }

    if(ok) score += pm;
  }

  fb.style.display="block";
  fb.className = "feedback " + (score===max ? "good" : (score>0 ? "" : "bad"));
  fb.innerHTML = `<b>Score:</b> ${score} / ${max}`;
}



function revealCurrent(){
  if(!current) return;
  const fb = document.getElementById("fb");
  if(!fb) return;
  fb.style.display = "block";

  const formatStd = (v)=>{
    const num = Number(v);
    if(!isFinite(num)) return String(v);
    if(num===0) return "0"; // avoid 10^0
    const sign = num<0 ? "−" : "";
    const abs = Math.abs(num);
    const n = Math.floor(Math.log10(abs));
    if(n===0) return sign + fmt(abs,4); // avoid 10^0
    const A = abs / Math.pow(10,n);
    return `${sign}${fmt(A,4)} × 10<sup>${n}</sup>`;
  };

  const formatPF = (map)=>{
    const parts = Object.entries(map)
      .sort((a,b)=>Number(a[0])-Number(b[0]))
      .map(([p,e])=>{
        const ee = Number(e);
        return ee===1 ? `${p}` : `${p}<sup>${ee}</sup>`;
      });
    return parts.join(" × ");
  };

  const answers = current.parts.map(p=>{
    const ex = p.answer;
    if(!ex) return "";
    if(ex.type==="fraction"){
      return mfrac(ex.value.n, ex.value.d);
    }
    if(ex.type==="order"){
      const tok=(t)=>{const s=String(t);const m=s.match(/^(-?\d+)\s*\/\s*(\d+)$/);return m?mfrac(parseInt(m[1],10),parseInt(m[2],10)):s;};
      return ex.value.map(tok).join(", ");
    }
    if(ex.type==="pair"){
      return `(${ex.value[0]}, ${ex.value[1]})`;
    }
    if(ex.type==="primeFactors"){
      return formatPF(ex.value);
    }
    if(ex.type==="standardForm"){
      return formatStd(ex.value);
    }
    if(ex.type==="time"){
      return String(ex.value);
    }
    if(ex.type==="rounded"){
      const dp = Number(ex.dp);
      if(Number.isFinite(dp)) return Number(ex.value).toFixed(dp);
      return String(ex.value);
    }
    if(p.input && p.input.kind==="money"){
      return "£" + Number(ex.value).toFixed(2);
    }
    return String(ex.value);
  });

  fb.innerHTML = `
    <div style="margin-top:10px">
      <b>Answers:</b>
      <ol style="margin:8px 0 0 18px">
        ${answers.map(a=>`<li>${a}</li>`).join("")}
      </ol>
    </div>
    
  `;
}





function generateNew(){
  const topic = topicSel.value;
  const marks = Number(marksSel.value);
  const paperMode = calcSel.value;

  const rng = makeRng(cryptoSeed());
  let q = buildQuestion(topic, marks, paperMode, rng);

  // Patch: N11(3) placeholder fix if needed
  if(q.topicCode==="N11" && q.marksTotal===3){
    // we generated a placeholder null; replace with a consistent y equation
    const xAns = q.parts[0].answer.value;
    const k = Math.floor(Math.random()*19)+2; // 2..20, OK for patch only
    q.parts[1].textHtml = `Now find <b>y</b>: <b>y − ${xAns} = ${k}</b>. <span class="endmark">[1]</span>`;
    q.parts[1].answer.value = xAns + k;
  }

  // Safety: ensure marks sum
  const sum = q.parts.reduce((s,p)=>s+(p.marks||0),0);
  if(sum !== q.marksTotal){
    console.warn("Marks mismatch; adjusting", {sum, expected:q.marksTotal});
    // force 1 mark each then remainder on last
    const parts = q.parts.map(p=>({...p, marks:1}));
    const remainder = q.marksTotal - parts.length;
    if(remainder>0) parts[parts.length-1].marks += remainder;
    q.parts = parts;
  }

  current = q;
  renderQuestion(q);
}

regenBtn.addEventListener("click", generateNew);
checkBtn.addEventListener("click", markCurrent);
revealBtn.addEventListener("click", revealCurrent);
topicSel.addEventListener("change", generateNew);
marksSel.addEventListener("change", generateNew);
calcSel.addEventListener("change", generateNew);

/* -------------------- init -------------------- */
initTopicDropdown();
generateNew();
</script>
</body>
</html>
